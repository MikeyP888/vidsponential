<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase API Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .loading { border-color: #2196F3; background: #f8f9ff; }
        pre { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .status { font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase API Connection Test</h1>
        <p>This page will test your Supabase connection and help diagnose API key issues.</p>
        
        <div class="test-section" id="configTest">
            <h3>1. Configuration Check</h3>
            <div class="status" id="configStatus">Checking configuration...</div>
            <pre id="configResult"></pre>
        </div>

        <div class="test-section" id="connectionTest">
            <h3>2. Basic Connection Test</h3>
            <button onclick="testConnection()">Test Connection</button>
            <div class="status" id="connectionStatus">Ready to test</div>
            <pre id="connectionResult"></pre>
        </div>

        <div class="test-section" id="scriptsTest">
            <h3>3. Scripts Count Test</h3>
            <button onclick="testScripts()">Check Scripts</button>
            <div class="status" id="scriptsStatus">Ready to test</div>
            <pre id="scriptsResult"></pre>
        </div>

        <div class="test-section" id="headersTest">
            <h3>4. Headers Debug</h3>
            <button onclick="testHeaders()">Debug Headers</button>
            <div class="status" id="headersStatus">Ready to test</div>
            <pre id="headersResult"></pre>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://euzbpslzrimyokzvgbzk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1emJwc2x6cmlteW9renZnYnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NDk5MTUsImV4cCI6MjA2NjEyNTkxNX0.HBznM8FVX0VnYBN8rTu6T-QOPmq0d60syavTCADl3JI';

        // Check configuration on load
        window.onload = function() {
            checkConfiguration();
        };

        function updateStatus(sectionId, status, className) {
            const section = document.getElementById(sectionId);
            const statusDiv = document.getElementById(sectionId.replace('Test', 'Status'));
            
            section.className = `test-section ${className}`;
            statusDiv.textContent = status;
        }

        function checkConfiguration() {
            const configResult = document.getElementById('configResult');
            
            const config = {
                url: SUPABASE_URL,
                keyLength: SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.length : 0,
                keyStart: SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.substring(0, 20) + '...' : 'NOT FOUND',
                urlValid: SUPABASE_URL && SUPABASE_URL.includes('supabase.co'),
                keyValid: SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ')
            };
            
            configResult.textContent = JSON.stringify(config, null, 2);
            
            if (config.urlValid && config.keyValid) {
                updateStatus('configTest', 'Configuration looks valid ✓', 'success');
            } else {
                updateStatus('configTest', 'Configuration issues detected ✗', 'error');
            }
        }

        async function testConnection() {
            updateStatus('connectionTest', 'Testing connection...', 'loading');
            const resultDiv = document.getElementById('connectionResult');
            
            try {
                // Test with a simple GET request
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                };

                if (response.ok) {
                    result.body = await response.text();
                } else {
                    result.errorBody = await response.text();
                }

                resultDiv.textContent = JSON.stringify(result, null, 2);
                
                if (response.ok) {
                    updateStatus('connectionTest', 'Connection successful ✓', 'success');
                } else {
                    updateStatus('connectionTest', `Connection failed: ${response.status}`, 'error');
                }
                
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}\n\nFull error: ${JSON.stringify(error, Object.getOwnPropertyNames(error), 2)}`;
                updateStatus('connectionTest', 'Connection failed ✗', 'error');
            }
        }

        async function testScripts() {
            updateStatus('scriptsTest', 'Checking scripts...', 'loading');
            const resultDiv = document.getElementById('scriptsResult');
            
            try {
                // Test scripts with status 15 and 25
                const tests = [
                    { status: 15, name: 'Outline Scripts' },
                    { status: 25, name: 'Chapter Scripts' },
                    { status: 'all', name: 'All Scripts' }
                ];

                const results = {};

                for (const test of tests) {
                    try {
                        const url = test.status === 'all' 
                            ? `${SUPABASE_URL}/rest/v1/scripts?select=script_id,script_status_id&limit=10`
                            : `${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.${test.status}&select=script_id,script_status_id`;

                        const response = await fetch(url, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            results[test.name] = {
                                count: data.length,
                                sample: data.slice(0, 3)
                            };
                        } else {
                            const errorText = await response.text();
                            results[test.name] = {
                                error: `${response.status}: ${errorText}`
                            };
                        }
                    } catch (err) {
                        results[test.name] = { error: err.message };
                    }
                }

                resultDiv.textContent = JSON.stringify(results, null, 2);
                
                const hasData = Object.values(results).some(r => r.count > 0);
                if (hasData) {
                    updateStatus('scriptsTest', 'Scripts found ✓', 'success');
                } else {
                    updateStatus('scriptsTest', 'No scripts found or access denied', 'error');
                }
                
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                updateStatus('scriptsTest', 'Scripts test failed ✗', 'error');
            }
        }

        async function testHeaders() {
            updateStatus('headersTest', 'Testing headers...', 'loading');
            const resultDiv = document.getElementById('headersResult');
            
            try {
                // Test what headers are actually being sent
                const testUrl = `${SUPABASE_URL}/rest/v1/scripts?select=script_id&limit=1`;
                
                // Create headers object for inspection
                const headers = {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };

                const debugInfo = {
                    url: testUrl,
                    headers: headers,
                    apiKeyLength: SUPABASE_ANON_KEY.length,
                    userAgent: navigator.userAgent
                };

                // Make the actual request
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: headers
                });

                debugInfo.response = {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                };

                if (!response.ok) {
                    debugInfo.responseBody = await response.text();
                }

                resultDiv.textContent = JSON.stringify(debugInfo, null, 2);
                
                if (response.ok) {
                    updateStatus('headersTest', 'Headers working ✓', 'success');
                } else {
                    updateStatus('headersTest', 'Headers issue detected ✗', 'error');
                }
                
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                updateStatus('headersTest', 'Headers test failed ✗', 'error');
            }
        }
    </script>
</body>
</html>