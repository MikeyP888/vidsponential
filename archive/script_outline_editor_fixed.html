<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Outline Editor</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    
    <link rel="stylesheet" href="../shared/styles/fonts.css">
    <link rel="stylesheet" href="../shared/styles/base.css">
    <link rel="stylesheet" href="../shared/styles/layout.css">
    <link rel="stylesheet" href="../shared/styles/buttons.css">
    <link rel="stylesheet" href="../shared/styles/forms.css">
    <link rel="stylesheet" href="../shared/styles/status.css">
    <link rel="stylesheet" href="../shared/styles/notifications.css">
    <link rel="stylesheet" href="../shared/styles/script_editor_styles.css">
    <link rel="stylesheet" href="../shared/styles/missing-layout.css">
</head>
<body>
    <div class="container">
        <!-- =============================================== -->
        <!--                 HEADER SECTION                -->
        <!-- =============================================== -->
        <div class="header">
            <!-- First horizontal container: Logo and Navigation Buttons -->
            <div class="top-bar">
                <img src="../shared/assets/vidsponential logo.png" alt="Vidsponential Logo" class="logo">
                <div class="header-buttons">
                    <a href="script_outline_editor.html" class="btn btn-primary header-btn navigation-btn" data-status="15">
                        Outlines
                        <span class="notification-badge" id="outlinesBadge" style="display: none;">0</span>
                    </a>
                    <a href="script_chapter_editor.html" class="btn btn-secondary header-btn navigation-btn" data-status="25">
                        Chapters
                        <span class="notification-badge" id="chaptersBadge" style="display: none;">0</span>
                    </a>
                    <a href="script_visuals_editor.html" class="btn btn-secondary header-btn navigation-btn" data-status="46">
                        Visuals
                        <span class="notification-badge" id="visualsBadge" style="display: none;">0</span>
                    </a>
                </div>
            </div>
            
            <!-- Second horizontal container: Status Indicator -->
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">Loading</div>
            </div>
            
            <!-- Third horizontal container: Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Script Outlines Completed Today: <span id="outlinesCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Fourth horizontal container: Overall Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Scripts Completed Today: <span id="scriptsCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Page Title -->
            <h1 class="page-title">Script Outline Editor</h1>
        </div>

        <!-- =============================================== -->
        <!--                 MAIN CONTENT                  -->
        <!-- =============================================== -->
        <div id="content">
            <!-- Script Info Section -->
            <div class="info-section">
                <div class="script-info" id="scriptInfo" style="display: none;">
                    <div class="info-item">
                        <div class="info-label">Script ID</div>
                        <div class="info-value" id="scriptIdValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Words</div>
                        <div class="info-value" id="wordsValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Client</div>
                        <div class="info-value" id="clientValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Channel</div>
                        <div class="info-value" id="channelValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Type</div>
                        <div class="info-value" id="typeValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Genre</div>
                        <div class="info-value" id="genreValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Subgenre</div>
                        <div class="info-value" id="subgenreValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Format</div>
                        <div class="info-value" id="formatValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Structure</div>
                        <div class="info-value" id="structureValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Research Depth</div>
                        <div class="info-value" id="researchValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tone</div>
                        <div class="info-value" id="toneValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Angle</div>
                        <div class="info-value" id="angleValue">-</div>
                    </div>
                </div>
            </div>
            <!-- Working Headline and Primary Keyword Fields -->
            <div class="main-fields">
                <!-- Working Headline Section -->
                <div class="headline-options">
                    <h2 class="section-title">Headline</h2>
                    <div class="chapter-se-7a2807fb2c0d">
                        <!-- Working Headline Row -->
                        <div class="ch-title-7a2807fb2c0f">
                            <!-- Headline Text + Label -->
                            <div class="title-la-7a2807fb2c1a">
                                <label class="label-ch-7a2807fb2c1f">Headline:</label>
                                <div class="title-fiel-7a2807fb2c1e">
                                    <textarea class="chapter-ti-7a2807fb2c20" id="workingHeadline" placeholder="Enter the working headline..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Headline Rating + Label -->
                            <div class="title-rating-l-7a2807fb2c19">
                                <label class="label-rat-7a2807fb2c1c">Rating / 100:</label>
                                <div class="rating-fie-7a2807fb2c1b">
                                    <input type="number" class="rating-7a2807fb2c1d" id="workingHeadlineRating" data-field="script_headline_mp_rating" min="1" max="100" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Primary Keyword Section -->
                <div class="headline-options">
                    <h2 class="section-title">Primary Keyword</h2>
                    <div class="chapter-se-7a2807fb2c0d">
                        <!-- Primary Keyword Row -->
                        <div class="ch-title-7a2807fb2c0f">
                            <!-- Keyword Text + Label -->
                            <div class="title-la-7a2807fb2c1a">
                                <label class="label-ch-7a2807fb2c1f">Primary Keyword:</label>
                                <div class="title-fiel-7a2807fb2c1e">
                                    <input type="text" class="chapter-ti-7a2807fb2c20" id="primaryKeyword" placeholder="Enter the primary keyword...">
                                </div>
                            </div>
                            
                            <!-- Keyword Rating + Label -->
                            <div class="title-rating-l-7a2807fb2c19">
                                <label class="label-rat-7a2807fb2c1c">Rating / 100:</label>
                                <div class="rating-fie-7a2807fb2c1b">
                                    <input type="number" class="rating-7a2807fb2c1d" id="primaryKeywordRating" data-field="primary_keyword_mp_rating" min="1" max="100" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Headline Options Section -->
            <div class="headline-options">
                <h2 class="section-title">Headline Options</h2>
                <div id="headlinesList"></div>
            </div>

            <!-- Chapter Outlines Section -->
            <div class="chapters-section">
                <h2 class="section-title">Chapter Outlines</h2>
                <div id="chaptersList"></div>
            </div>
        </div>

        <!-- =============================================== -->
        <!--                 NO SCRIPTS MESSAGE            -->
        <!-- =============================================== -->
        <div id="noScriptsMessage" class="message" style="display: none;">
            No script outlines to display - everything checked ‚úì
        </div>

        <!-- =============================================== -->
        <!--                 CONTROLS SECTION              -->
        <!-- =============================================== -->
        <div class="controls">
            <div class="controls-row">
                <div class="navigation">
                    <button class="btn btn-secondary" id="prevBtn" onclick="navigateScript(-1)">‚Üê Previous</button>
                    <button class="btn btn-secondary" id="nextBtn" onclick="navigateScript(1)">Next ‚Üí</button>
                </div>
                <div>
                    <div class="auto-save-indicator" id="autoSaveStatus">Auto-save: Ready</div>
                </div>
                <div>
                    <button class="btn btn-success" id="saveBtn" onclick="saveScript()">Save & Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INLINE SCRIPT - NO MODULE LOADING -->
    <script>
        // Configuration constants
        const SUPABASE_URL = 'https://euzbpslzrimyokzvgbzk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1emJwc2x6cmlteW9renZnYnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NDk5MTUsImV4cCI6MjA2NjEyNTkxNX0.HBznM8FVX0VnYBN8rTu6T-QOPmq0d60syavTCADl3JI';
        const AUTO_SAVE_INTERVAL = 30000; // 30 seconds
        const SCRIPT_STATUS = { READY_FOR_OUTLINE: 15, OUTLINE_COMPLETED: 20 };
        const COMPLETION_TYPES = { OUTLINE_COMPLETED: 'outline_completed', SCRIPT_COMPLETED: 'script_completed' };
        
        // Application state
        let currentScriptData = null;
        let scriptsToReview = [];
        let currentScriptIndex = 0;
        let isLoading = false;
        let hasUnsavedChanges = false;

        // Utility functions
        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.className = `status-indicator ${type}`;
            }
        }

        function updateNavigationButtons(currentIndex, scripts) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) prevBtn.disabled = currentIndex <= 0;
            if (nextBtn) nextBtn.disabled = currentIndex >= scripts.length - 1;
        }

        function showNoScriptsMessage() {
            document.getElementById('content').style.display = 'none';
            document.getElementById('noScriptsMessage').style.display = 'block';
        }

        // API functions
        async function loadScriptsToReview() {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.15&select=script_id,script_headline`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to load scripts: ${response.status} - ${errorText}`);
            }

            return await response.json();
        }

        async function loadCurrentScript(scriptId) {
            try {
                const scriptResponse = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!scriptResponse.ok) {
                    throw new Error(`Failed to load script: ${scriptResponse.status}`);
                }

                const [script] = await scriptResponse.json();
                return { script };
            } catch (error) {
                console.error('Error loading script:', error);
                throw error;
            }
        }

        async function saveCurrentData(scriptData, changeStatus = false) {
            const scriptId = scriptData.script.script_id;
            
            const updateData = {
                script_headline: document.getElementById('workingHeadline')?.value || '',
                primary_keyword: document.getElementById('primaryKeyword')?.value || '',
                script_headline_mp_rating: parseInt(document.getElementById('workingHeadlineRating')?.value) || null,
                primary_keyword_mp_rating: parseInt(document.getElementById('primaryKeywordRating')?.value) || null
            };

            if (changeStatus) {
                updateData.script_status_id = SCRIPT_STATUS.OUTLINE_COMPLETED;
            }

            const response = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to save: ${response.status} - ${errorText}`);
            }
        }

        async function loadNotificationCounts() {
            try {
                const [outlines, chapters] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.15&select=script_id`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    }).then(r => r.json()),
                    fetch(`${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.25&select=script_id`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    }).then(r => r.json())
                ]);

                return { outlines: outlines.length, chapters: chapters.length };
            } catch (error) {
                console.error('Error loading notification counts:', error);
                return { outlines: 0, chapters: 0 };
            }
        }

        async function loadCompletedTodayCount() {
            return { outlines: 0, scripts: 0 }; // Simplified for now
        }

        // UI functions
        function displayScriptData(data) {
            const script = data.script;
            
            // Show script info
            document.getElementById('scriptInfo').style.display = 'block';
            document.getElementById('scriptIdValue').textContent = script.script_id;
            document.getElementById('wordsValue').textContent = script.target_word_count || '-';
            
            // Load form fields
            const headlineField = document.getElementById('workingHeadline');
            const keywordField = document.getElementById('primaryKeyword');
            const headlineRatingField = document.getElementById('workingHeadlineRating');
            const keywordRatingField = document.getElementById('primaryKeywordRating');
            
            if (headlineField) headlineField.value = script.script_headline || '';
            if (keywordField) keywordField.value = script.primary_keyword || '';
            if (headlineRatingField) headlineRatingField.value = script.script_headline_mp_rating || '';
            if (keywordRatingField) keywordRatingField.value = script.primary_keyword_mp_rating || '';
        }

        function setupEventListeners() {
            // Add change listeners to form fields
            const formFields = ['workingHeadline', 'primaryKeyword', 'workingHeadlineRating', 'primaryKeywordRating'];
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        hasUnsavedChanges = true;
                        field.classList.add('unsaved');
                    });
                }
            });
        }

        function updateNotificationBadges(counts) {
            const outlinesBadge = document.getElementById('outlinesBadge');
            const chaptersBadge = document.getElementById('chaptersBadge');
            
            if (outlinesBadge) {
                outlinesBadge.textContent = counts.outlines;
                outlinesBadge.style.display = counts.outlines > 0 ? 'inline' : 'none';
            }
            
            if (chaptersBadge) {
                chaptersBadge.textContent = counts.chapters;
                chaptersBadge.style.display = counts.chapters > 0 ? 'inline' : 'none';
            }
        }

        function updateCompletionCounts(counts) {
            const outlinesCount = document.getElementById('outlinesCompletedTodayCount');
            const scriptsCount = document.getElementById('scriptsCompletedTodayCount');
            
            if (outlinesCount) outlinesCount.textContent = counts.outlines;
            if (scriptsCount) scriptsCount.textContent = counts.scripts;
        }

        // Main functions
        async function loadCurrentScriptData() {
            if (scriptsToReview.length === 0) {
                showNoScriptsMessage();
                return;
            }

            const scriptId = scriptsToReview[currentScriptIndex].script_id;
            
            try {
                updateStatus('loading', 'Loading script data...');
                currentScriptData = await loadCurrentScript(scriptId);
                displayScriptData(currentScriptData);
                updateNavigationButtons(currentScriptIndex, scriptsToReview);
                updateStatus('saved', 'Loaded successfully');
                hasUnsavedChanges = false;
            } catch (error) {
                console.error('Error loading script:', error);
                updateStatus('error', 'Failed to load script data');
            }
        }

        async function saveScript() {
            await performSave(true, true);
        }

        async function performSave(changeStatus = false, showValidationErrors = false) {
            if (isLoading) return;

            isLoading = true;
            updateStatus('loading', 'Saving...');

            try {
                await saveCurrentData(currentScriptData, changeStatus);
                
                hasUnsavedChanges = false;
                document.querySelectorAll('.unsaved').forEach(el => {
                    el.classList.remove('unsaved');
                });

                if (changeStatus) {
                    // Remove from review list
                    scriptsToReview.splice(currentScriptIndex, 1);
                    
                    // Refresh counts
                    const [notificationCounts, completionCounts] = await Promise.all([
                        loadNotificationCounts(),
                        loadCompletedTodayCount()
                    ]);
                    
                    updateNotificationBadges(notificationCounts);
                    updateCompletionCounts(completionCounts);
                    
                    if (scriptsToReview.length === 0) {
                        showNoScriptsMessage();
                    } else {
                        if (currentScriptIndex >= scriptsToReview.length) {
                            currentScriptIndex = 0;
                        }
                        await loadCurrentScriptData();
                    }
                    updateStatus('saved', 'Saved & moved to next');
                } else {
                    updateStatus('saved', 'Saved');
                }

            } catch (error) {
                console.error('Save error:', error);
                updateStatus('error', 'Save failed: ' + error.message);
            } finally {
                isLoading = false;
            }
        }

        async function navigateScript(direction) {
            if (isLoading) return;

            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Do you want to continue without saving?')) {
                    return;
                }
            }

            const newIndex = currentScriptIndex + direction;
            if (newIndex >= 0 && newIndex < scriptsToReview.length) {
                currentScriptIndex = newIndex;
                await loadCurrentScriptData();
            }
        }

        // Auto-save functionality
        function startAutoSave() {
            setInterval(() => {
                if (hasUnsavedChanges && !isLoading) {
                    autoSave();
                }
            }, AUTO_SAVE_INTERVAL);
        }

        async function autoSave() {
            try {
                const autoSaveStatus = document.getElementById('autoSaveStatus');
                if (autoSaveStatus) {
                    autoSaveStatus.textContent = 'Auto-save: Saving...';
                }
                
                await performSave(false, false);
                
                if (autoSaveStatus) {
                    autoSaveStatus.textContent = 'Auto-save: Saved';
                    setTimeout(() => {
                        autoSaveStatus.textContent = 'Auto-save: Ready';
                    }, 2000);
                }
            } catch (error) {
                const autoSaveStatus = document.getElementById('autoSaveStatus');
                if (autoSaveStatus) {
                    autoSaveStatus.textContent = 'Auto-save: Failed';
                }
                console.error('Auto-save failed:', error);
            }
        }

        // Main initialization
        async function init() {
            try {
                console.log('Starting initialization...');
                updateStatus('loading', 'Loading scripts...');
                
                // Load initial data
                const [notificationCounts, completionCounts, scripts] = await Promise.all([
                    loadNotificationCounts(),
                    loadCompletedTodayCount(),
                    loadScriptsToReview()
                ]);
                
                console.log('Loaded data:', { notificationCounts, completionCounts, scriptsCount: scripts.length });
                
                // Update UI with counts
                updateNotificationBadges(notificationCounts);
                updateCompletionCounts(completionCounts);
                
                // Set scripts data
                scriptsToReview = scripts;
                
                if (scripts.length > 0) {
                    console.log('Loading first script...');
                    await loadCurrentScriptData();
                    setupEventListeners();
                    startAutoSave();
                } else {
                    console.log('No scripts found, showing message...');
                    showNoScriptsMessage();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('error', `Failed to load scripts: ${error.message}`);
                
                document.getElementById('noScriptsMessage').innerHTML = `
                    <div class="message error">
                        <strong>Error loading scripts:</strong><br>
                        ${error.message}<br><br>
                        <small>Check the browser console (F12) for more details.</small>
                    </div>
                `;
                document.getElementById('content').style.display = 'none';
                document.getElementById('noScriptsMessage').style.display = 'block';
            }
        }

        // Make functions available globally
        window.saveScript = saveScript;
        window.navigateScript = navigateScript;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting initialization...');
            init().catch(error => {
                console.error('Failed to initialize app:', error);
            });
        });
    </script>
</body>
</html>