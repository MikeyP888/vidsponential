<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Outline Editor</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <link rel="stylesheet" href="../../shared/styles/theme.css">
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/script_editor_styles.css">
    <link rel="stylesheet" href="../../shared/styles/missing-layout.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">
    <link rel="stylesheet" href="../../shared/styles/bottom-navigation.css">
</head>
<body class="has-sidebar">
    <!-- Sticky Top Status Bar -->
    <div id="stickyStatusBar" style="
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        background: transparent;
        padding: 4px 20px;
        z-index: 999;
        display: flex;
        justify-content: space-between;
        align-items: center;
        pointer-events: none;
    ">
        <!-- Script Info Pill (Left) -->
        <div id="stickyScriptInfo" style="
            background: white;
            padding: 3.6px 10.8px;
            border-radius: 18px;
            font-size: 10.8px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            pointer-events: auto;
            display: none;
        ">-</div>

        <!-- Status Indicator Pill (Right) -->
        <div class="status-indicator" id="stickyStatusIndicator" style="pointer-events: auto;">Loading</div>
    </div>

    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>

    <div class="container with-sidebar" style="padding-top: 30px;">
        <!-- =============================================== -->
        <!--                 HEADER SECTION                -->
        <!-- =============================================== -->
        <div class="header">
            
            <!-- Status bar removed - now in sticky top bar -->

            <!-- Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Chapter Outlines Completed Today: <span id="outlinesCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Fourth horizontal container: Overall Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Scripts Completed Today: <span id="scriptsCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Page Title -->
            <h1 class="page-title">Script Chapter Outline Editor</h1>
        </div>

        <!-- =============================================== -->
        <!--                 MAIN CONTENT                  -->
        <!-- =============================================== -->
        <div id="content">
            <!-- Script Info Section -->
            <div id="scriptInfoBox"></div>

            <!-- Headlines Section -->
            <div class="headlines-section">
                <h2 class="section-title">Headlines</h2>
                
                <!-- Script Headline Section -->
                <div class="chapter-se-7a2807fb2c0d">
                    <!-- Script Headline Header Button -->
                    <button class="gradient-button">
                        <span class="gradient-button__text">Script Headline</span>
                    </button>
                    
                    <!-- Script Headline Row -->
                    <div class="ch-title-7a2807fb2c0f">
                        <!-- Script Headline Text + Label -->
                        <div class="form-row__text-field">
                            <label class="label-ch-7a2807fb2c1f">Script Headline:</label>
                            <div class="title-fiel-7a2807fb2c1e">
                                <input type="text" class="chapter-ti-7a2807fb2c20" 
                                       id="script_headline" 
                                       data-field="script_headline"
                                       placeholder="Enter script headline..."
                                       value="">
                            </div>
                        </div>
                        
                        <!-- Script Headline Rating + Label -->
                        <div class="form-row__rating-field">
                            <div class="rating-field">
                                <label class="rating-field__label">Rating / 100:</label>
                                <div class="rating-field__container">
                                    <input type="number"
                                           class="rating-field__input"
                                           id="script_headline_rating"
                                           data-field="script_headline_rating"
                                           min="1" max="100"
                                           value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Alternative Headline Options Section -->
                <div class="alternative-headlines-section">
                    <h3 class="section-subtitle">Alternative Headline Options</h3>
                    <div id="alternativeHeadlinesList">
                        <!-- Alternative headlines will be populated here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Chapter Outlines Section -->
            <div class="chapters-section">
                <h2 class="section-title">Chapter Outlines</h2>
                <div id="chaptersList">
                    <!-- Chapters will be populated here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- =============================================== -->
        <!--                 NO SCRIPTS MESSAGE            -->
        <!-- =============================================== -->
        <div id="noScriptsMessage" class="message" style="display: none;">
            No script outlines to display - everything checked ‚úì
        </div>

        <!-- Bottom navigation will be added by JavaScript -->
    </div>

        <script src="../../shared/js/theme-manager.js"></script>
    <script type="module" src="../../shared/js/sidebar-component.js"></script>
    <script type="module" src="../../shared/js/textarea-autosize.js"></script>
    <script type="module">
        // Chapter Outline Editor Application
        
        import { SUPABASE_URL, SUPABASE_ANON_KEY, SCRIPT_STATUS } from '../../shared/js/config.js';
        import { updateStatus, displayScriptInfo, loadScriptInfo, updateScriptStatus, showNoScriptsMessage, fetchWithErrorHandling } from '../../shared/js/editor-utils.js';
        import { loadRatings, saveRatings, collectRatingValues, populateRatingFields } from '../../shared/js/rating-utils.js';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Application state
        let currentScriptData = null;
        let scriptsToReview = [];
        let pageConfig = null;
        let currentScriptIndex = 0;
        let hasUnsavedChanges = false;
        let isLoading = false;

        // Initialize the application
        async function init() {
            try {
                updateStatus('loading', 'Loading page configuration...');

                // Get page configuration
                const pageName = window.location.pathname.split('/').pop().replace('.html', '');

                const { data: config, error: configError } = await supabase
                    .from('html_page_config')
                    .select('*')
                    .eq('page_name', pageName)
                    .single();

                if (configError || !config) {
                    throw new Error(`Page configuration not found for: ${pageName}`);
                }

                pageConfig = config;

                // Set page title dynamically
                document.title = pageConfig.page_title;
                const h1Element = document.querySelector('h1.page-title');
                if (h1Element) {
                    h1Element.textContent = pageConfig.page_title;
                }

                updateStatus('loading', `Loading ${pageConfig.page_title.toLowerCase()}...`);

                // Filter records using config
                const url = `${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.status_field_name}=eq.${pageConfig.display_status_id}&select=${pageConfig.id_field_name},${pageConfig.status_table_name === 'scripts' ? 'script_headline' : 'headline'}`;
                const scripts = await fetchWithErrorHandling(url);
                scriptsToReview = scripts;

                if (scripts.length > 0) {
                    console.log('Loading first script with ID:', scripts[0][pageConfig.id_field_name]);
                    await loadCurrentScriptData();
                    setupEventListeners();
                    startAutoSave();
                } else {
                    showNoScriptsMessage(`There are no ${pageConfig.page_title.toLowerCase()} ready for editing at this time.`);
                }
            } catch (error) {
                console.error('Script Outline Editor initialization error:', error);
                updateStatus('error', `Failed to load scripts: ${error.message}`);
            }
        }

        // Load current script data
        async function loadCurrentScriptData() {
            if (scriptsToReview.length === 0) {
                showNoScriptsMessage();
                return;
            }

            const scriptId = scriptsToReview[currentScriptIndex][pageConfig.id_field_name];
            console.log('Loading chapter data for script ID:', scriptId);

            try {
                updateStatus('loading', 'Loading script data...');

                const scriptInfo = await loadScriptInfo(scriptId);
                const chaptersData = await loadChaptersData(scriptId);
                const headlinesData = await loadHeadlinesData(scriptId);

                // Load centralized ratings for scripts table
                const scriptRatings = await loadRatings('scripts', scriptId, [
                    'script_headline',
                    'primary_keyword'
                ]);

                // Load ratings for each chapter
                const chapterRatings = {};
                for (const chapter of chaptersData) {
                    const ratings = await loadRatings('chapters', chapter.chapter_id, [
                        'chapter_outline',
                        'chapter_headline'
                    ]);
                    chapterRatings[chapter.chapter_id] = ratings;
                }

                // Load ratings for each headline
                const headlineRatings = {};
                for (const headline of headlinesData) {
                    const ratings = await loadRatings('headlines', headline.headline_id, [
                        'headline'
                    ]);
                    headlineRatings[headline.headline_id] = ratings;
                }

                currentScriptData = {
                    script: scriptInfo,
                    chapters: chaptersData,
                    headlines: headlinesData,
                    scriptRatings: scriptRatings,
                    chapterRatings: chapterRatings,
                    headlineRatings: headlineRatings
                };

                displayScriptData(currentScriptData);
                updateNavigationButtons();
                updateStatus('saved', 'Loaded successfully');
                hasUnsavedChanges = false;
            } catch (error) {
                console.error('Error loading script:', error);
                updateStatus('error', 'Failed to load script data');
            }
        }

        // Using loadScriptInfo from editor-utils.js

        // Load chapters data from the chapters table
        async function loadChaptersData(scriptId) {
            const url = `${SUPABASE_URL}/rest/v1/chapters?script_id=eq.${scriptId}&select=*&order=chapter_number.asc`;
            try {
                return await fetchWithErrorHandling(url);
            } catch (error) {
                console.warn('No chapters data found for script:', scriptId);
                return [];
            }
        }

        // Load headlines data from the headlines table
        async function loadHeadlinesData(scriptId) {
            const url = `${SUPABASE_URL}/rest/v1/headlines?script_id=eq.${scriptId}&select=*`;
            try {
                return await fetchWithErrorHandling(url);
            } catch (error) {
                console.warn('No headlines data found for script:', scriptId);
                return [];
            }
        }

        // Display script data in UI
        function displayScriptData(data) {
            if (!data) return;

            document.getElementById('content').style.display = 'block';
            document.getElementById('noScriptsMessage').style.display = 'none';

            // Use utility function to display script info
            displayScriptInfo(data.script);

            // Try to initialize enhanced script info box (non-blocking)
            initializeScriptInfoBox(data.script.script_id);


            // Update sticky script info pill
            const stickyScriptInfo = document.getElementById('stickyScriptInfo');
            if (stickyScriptInfo && data.script) {
                const scriptId = data.script.script_id || '-';
                const scriptHeadline = data.script.script_headline || 'Untitled';
                stickyScriptInfo.textContent = `Script ID: ${scriptId} | ${scriptHeadline}`;
                stickyScriptInfo.style.display = 'block';
            }

            // Update script headline fields
            const scriptHeadlineEl = document.getElementById('script_headline');

            if (scriptHeadlineEl) scriptHeadlineEl.value = data.script.script_headline || '';

            // Display alternative headlines
            displayAlternativeHeadlines(data.headlines);

            // Populate headline ratings from centralized system
            if (data.headlineRatings) {
                for (const headlineId in data.headlineRatings) {
                    const ratingInput = document.getElementById(`alternative_headline_rating_${headlineId}`);
                    if (ratingInput && data.headlineRatings[headlineId].headline) {
                        ratingInput.value = data.headlineRatings[headlineId].headline;
                    }
                }
            }

            // Display chapters
            displayChapters(data.chapters, data.chapterRatings);

            // Populate script ratings from centralized system
            if (data.scriptRatings) {
                const scriptHeadlineRatingEl = document.getElementById('script_headline_rating');
                if (scriptHeadlineRatingEl && data.scriptRatings.script_headline) {
                    scriptHeadlineRatingEl.value = data.scriptRatings.script_headline;
                }
            }
        }

        // Display alternative headlines from the headlines table
        function displayAlternativeHeadlines(headlines) {
            console.log('displayAlternativeHeadlines called with:', headlines);
            const container = document.getElementById('alternativeHeadlinesList');
            container.innerHTML = '';

            if (!headlines || headlines.length === 0) {
                console.log('No headlines to display, headlines array:', headlines);
                container.innerHTML = `
                    <div class="message info">
                        <strong>No alternative headlines found</strong><br>
                        No alternative headlines are available for this script in the database.
                    </div>
                `;
                return;
            }

            console.log('Displaying', headlines.length, 'headlines');

            // Create the overall section container
            const headlinesSection = document.createElement('div');
            headlinesSection.className = 'chapter-se-7a2807fb2c0d';
            
            // Add the header button for the entire section
            headlinesSection.innerHTML = `
                <!-- Alternative Headlines Header Button -->
                <button class="gradient-button">
                    <span class="gradient-button__text">Alternative Headlines (${headlines.length})</span>
                </button>
            `;

            headlines.forEach((headline, index) => {
                console.log(`Processing headline ${index + 1}:`, headline);
                
                // Use script_id + index as identifier if no unique id exists
                const headlineKey = headline.headline_id || headline.id || `${headline.script_id}_${index}`;
                
                // Create individual headline row
                const headlineRow = document.createElement('div');
                headlineRow.className = 'ch-title-7a2807fb2c0f';
                
                headlineRow.innerHTML = `
                    <!-- Alternative Headline Text + Label -->
                    <div class="form-row__text-field">
                        <label class="label-ch-7a2807fb2c1f">Headline ${index + 1}:</label>
                        <div class="title-fiel-7a2807fb2c1e">
                            <input type="text" class="chapter-ti-7a2807fb2c20" 
                                   id="alternative_headline_${headlineKey}" 
                                   data-headline-id="${headlineKey}"
                                   data-headline-key="${headlineKey}"
                                   data-field="headline"
                                   placeholder="Enter alternative headline..."
                                   value="${headline.headline || ''}">
                        </div>
                    </div>
                    
                    <!-- Alternative Headline Rating + Label -->
                    <div class="form-row__rating-field">
                        <div class="rating-field">
                            <label class="rating-field__label">Rating / 100:</label>
                            <div class="rating-field__container">
                                <input type="number"
                                       class="rating-field__input"
                                       id="alternative_headline_rating_${headlineKey}"
                                       data-headline-id="${headlineKey}"
                                       data-headline-key="${headlineKey}"
                                       data-field="headline_rating"
                                       min="1" max="100"
                                       value="">
                            </div>
                        </div>
                    </div>
                `;
                
                headlinesSection.appendChild(headlineRow);
            });
            
            container.appendChild(headlinesSection);
        }

        // Safely initialize enhanced script info box
        async function initializeScriptInfoBox(scriptId) {
            try {
                // Dynamically import the ScriptInfoBox component
                const { default: ScriptInfoBox } = await import('../../shared/js/script-info-box.js');

                const scriptInfoBox = new ScriptInfoBox('scriptInfoBox');
                await scriptInfoBox.init(scriptId, {
                    autoRefresh: false,
                    refreshRate: 30000
                });

                // Hide the old info box and show the new one
                const oldInfoBox = document.getElementById('scriptInfo');
                if (oldInfoBox) {
                    oldInfoBox.style.display = 'none';
                }

                console.log('Enhanced script info box loaded successfully');
            } catch (error) {
                console.log('Enhanced script info box not available, using standard version:', error);
                // Fallback: ensure the old info box is visible
                const oldInfoBox = document.getElementById('scriptInfo');
                if (oldInfoBox) {
                    oldInfoBox.style.display = 'block';
                }
            }
        }

        // Display chapters from the chapters table
        function displayChapters(chapters, chapterRatings) {
            const container = document.getElementById('chaptersList');
            container.innerHTML = '';

            if (!chapters || chapters.length === 0) {
                container.innerHTML = `
                    <div class="message info">
                        <strong>No chapters found</strong><br>
                        No chapters are available for this script in the database.
                    </div>
                `;
                return;
            }

            chapters.forEach(chapter => {
                const chapterSection = document.createElement('div');
                chapterSection.className = 'chapter-se-7a2807fb2c0d';

                chapterSection.innerHTML = `
                    <!-- Chapter Header Button -->
                    <button class="gradient-button">
                        <span class="gradient-button__text">Chapter ${chapter.chapter_number || 'N/A'}</span>
                    </button>

                    <!-- Chapter Title Row -->
                    <div class="ch-title-7a2807fb2c0f">
                        <!-- Chapter Title Text + Label -->
                        <div class="form-row__text-field">
                            <label class="label-ch-7a2807fb2c1f">Chapter Title:</label>
                            <div class="title-fiel-7a2807fb2c1e">
                                <input type="text" class="chapter-ti-7a2807fb2c20"
                                       id="chapter_headline_${chapter.chapter_id}"
                                       data-chapter-id="${chapter.chapter_id}"
                                       data-field="chapter_headline"
                                       placeholder="Enter chapter title..."
                                       value="${chapter.chapter_headline || ''}">
                            </div>
                        </div>

                        <!-- Chapter Title Rating + Label -->
                        <div class="form-row__rating-field">
                            <div class="rating-field">
                                <label class="rating-field__label">Rating / 100:</label>
                                <div class="rating-field__container">
                                    <input type="number"
                                           class="rating-field__input"
                                           id="chapter_headline_rating_${chapter.chapter_id}"
                                           data-chapter-id="${chapter.chapter_id}"
                                           data-field="chapter_headline_rating"
                                           min="1" max="100"
                                           value="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chapter Outline Content -->
                    <div class="form-row">
                        <div class="form-row__text-field">
                            <div class="text-field-multi">
                                <div class="text-field-multi__container">
                                    <textarea class="text-field-multi__input"
                                             id="chapter_outline_${chapter.chapter_id}"
                                             data-chapter-id="${chapter.chapter_id}"
                                             data-field="chapter_outline"
                                             style="min-height: 300px; height: 300px;"
                                             placeholder="Enter chapter outline...">${chapter.chapter_outline || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-row__rating-field">
                            <div class="rating-field">
                                <label class="rating-field__label">Rating / 100:</label>
                                <div class="rating-field__container">
                                    <input type="number"
                                           class="rating-field__input"
                                           id="chapter_outline_rating_${chapter.chapter_id}"
                                           data-chapter-id="${chapter.chapter_id}"
                                           data-field="chapter_outline_rating"
                                           min="1"
                                           max="100"
                                           value="">
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(chapterSection);

                // Populate chapter ratings from centralized system
                if (chapterRatings && chapterRatings[chapter.chapter_id]) {
                    const ratings = chapterRatings[chapter.chapter_id];
                    const headlineRatingEl = document.getElementById(`chapter_headline_rating_${chapter.chapter_id}`);
                    const outlineRatingEl = document.getElementById(`chapter_outline_rating_${chapter.chapter_id}`);

                    if (headlineRatingEl && ratings.chapter_headline) {
                        headlineRatingEl.value = ratings.chapter_headline;
                    }
                    if (outlineRatingEl && ratings.chapter_outline) {
                        outlineRatingEl.value = ratings.chapter_outline;
                    }
                }
            });
        }

        // Save script function - Updates chapter outlines in the chapters table
        async function saveScript() {
            if (isLoading) return;
            
            try {
                isLoading = true;
                updateStatus('loading', 'Saving chapter outlines...');
                
                const scriptId = scriptsToReview[currentScriptIndex][pageConfig.id_field_name];
                await saveChapterOutlines(scriptId);
                
                // Update script status from 15 to 20
                // Update status using configuration
                if (pageConfig && pageConfig.next_status_id) {
                    await updateScriptStatus(scriptId, pageConfig.next_status_id);
                }
                
                updateStatus('saved', 'Chapter outlines saved and status updated to 20');
                hasUnsavedChanges = false;
                if (window.setUnsavedChanges) {
                    window.setUnsavedChanges(false);
                }
                
                // Move to next script
                scriptsToReview.splice(currentScriptIndex, 1);
                
                if (scriptsToReview.length > 0) {
                    if (currentScriptIndex >= scriptsToReview.length) {
                        currentScriptIndex = 0;
                    }
                    await loadCurrentScriptData();
                } else {
                    updateStatus('completed', 'All chapter outlines completed!');
                    showNoScriptsMessage();
                }
                
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('error', `Failed to save chapter outlines: ${error.message}`);
            } finally {
                isLoading = false;
            }
        }

        // Save chapter outlines data
        async function saveChapterOutlines(scriptId) {
            // First, save script headline data
            const scriptHeadline = document.getElementById('script_headline').value;

            // Update script table with headline data (without rating)
            const url = `${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}`;
            await fetchWithErrorHandling(url, {
                method: 'PATCH',
                body: JSON.stringify({
                    script_headline: scriptHeadline
                }),
                headers: { 'Prefer': 'return=minimal' }
            });

            // Save script ratings to centralized system
            const scriptHeadlineRating = document.getElementById('script_headline_rating').value;
            if (scriptHeadlineRating) {
                await saveRatings('scripts', scriptId, {
                    'script_headline': parseInt(scriptHeadlineRating)
                }, scriptId);
            }

            // Save alternative headlines data
            const headlineFields = document.querySelectorAll('[data-headline-id]');
            const updatesByHeadline = {};
            const ratingsByHeadline = {};

            // Collect all updates by headline ID
            headlineFields.forEach(field => {
                const headlineId = field.dataset.headlineId;
                const fieldType = field.dataset.field;

                // Skip if headlineId is not a valid database ID (like "scriptId_index")
                const parsedId = parseInt(headlineId);
                if (isNaN(parsedId) || headlineId.includes('_')) {
                    console.log('Skipping non-database headline:', headlineId);
                    return;
                }

                if (!updatesByHeadline[headlineId]) {
                    updatesByHeadline[headlineId] = { id: parsedId };
                    ratingsByHeadline[headlineId] = {};
                }

                if (fieldType === 'headline') {
                    updatesByHeadline[headlineId].headline = field.value;
                } else if (fieldType === 'headline_rating') {
                    // Collect rating separately for centralized system
                    if (field.value) {
                        ratingsByHeadline[headlineId].headline = parseInt(field.value);
                    }
                }
            });

            // Save each headline individually
            for (const headlineId in updatesByHeadline) {
                const update = updatesByHeadline[headlineId];
                const { id, ...updateData } = update;

                const headlineUrl = `${SUPABASE_URL}/rest/v1/headlines?headline_id=eq.${id}`;
                await fetchWithErrorHandling(headlineUrl, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData),
                    headers: { 'Prefer': 'return=minimal' }
                });

                // Save headline ratings to centralized system
                if (ratingsByHeadline[headlineId] && Object.keys(ratingsByHeadline[headlineId]).length > 0) {
                    await saveRatings('headlines', id, ratingsByHeadline[headlineId], scriptId);
                }
            }

            // Then save chapter data
            const chapterFields = document.querySelectorAll('[data-chapter-id]');
            const updatesByChapter = {};
            const ratingsByChapter = {};

            // Collect all updates by chapter ID
            chapterFields.forEach(field => {
                const chapterId = field.dataset.chapterId;
                const fieldType = field.dataset.field;

                if (!updatesByChapter[chapterId]) {
                    updatesByChapter[chapterId] = { id: parseInt(chapterId) };
                    ratingsByChapter[chapterId] = {};
                }

                if (fieldType === 'chapter_headline') {
                    updatesByChapter[chapterId].chapter_headline = field.value;
                } else if (fieldType === 'chapter_headline_rating') {
                    // Collect rating separately for centralized system
                    if (field.value) {
                        ratingsByChapter[chapterId].chapter_headline = parseInt(field.value);
                    }
                } else if (fieldType === 'chapter_outline') {
                    updatesByChapter[chapterId].chapter_outline = field.value;
                } else if (fieldType === 'chapter_outline_rating') {
                    // Collect rating separately for centralized system
                    if (field.value) {
                        ratingsByChapter[chapterId].chapter_outline = parseInt(field.value);
                    }
                }
            });

            // Save each chapter individually
            for (const chapterId in updatesByChapter) {
                const update = updatesByChapter[chapterId];
                const { id, ...updateData } = update;

                const chapterUrl = `${SUPABASE_URL}/rest/v1/chapters?chapter_id=eq.${id}`;
                await fetchWithErrorHandling(chapterUrl, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData),
                    headers: { 'Prefer': 'return=minimal' }
                });

                // Save chapter ratings to centralized system
                if (ratingsByChapter[chapterId] && Object.keys(ratingsByChapter[chapterId]).length > 0) {
                    await saveRatings('chapters', id, ratingsByChapter[chapterId], scriptId);
                }
            }
        }

        // Navigate between scripts
        async function navigateScript(direction) {
            if (isLoading) return;

            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Do you want to continue without saving?')) {
                    return;
                }
            }

            const newIndex = currentScriptIndex + direction;
            if (newIndex >= 0 && newIndex < scriptsToReview.length) {
                currentScriptIndex = newIndex;
                await loadCurrentScriptData();
            }
        }

        // Update navigation button states
        function updateNavigationButtons() {
            if (window.updateBottomNavigation) {
                window.updateBottomNavigation(currentScriptIndex, scriptsToReview.length);
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Add change listeners to mark unsaved changes
            document.addEventListener('input', (e) => {
                if ((e.target.dataset.field && e.target.dataset.chapterId) ||
                    (e.target.dataset.field && e.target.dataset.headlineId) ||
                    e.target.dataset.field === 'script_headline' ||
                    e.target.dataset.field === 'script_headline_rating') {
                    hasUnsavedChanges = true;
                    if (window.setUnsavedChanges) {
                        window.setUnsavedChanges(true);
                    }
                    updateStatus('editing', 'Editing data...');
                }
            });
        }

        // Auto-save functionality
        function startAutoSave() {
            if (window.bottomNav) {
                window.bottomNav.startAutoSave(async () => {
                    if (hasUnsavedChanges && currentScriptData) {
                        try {
                            const scriptId = scriptsToReview[currentScriptIndex][pageConfig.id_field_name];
                            await saveChapterOutlines(scriptId);
                            hasUnsavedChanges = false;
                            if (window.setUnsavedChanges) {
                                window.setUnsavedChanges(false);
                            }
                            updateStatus('saved', 'Auto-saved');
                        } catch (error) {
                            console.error('Auto-save failed:', error);
                            updateStatus('error', 'Auto-save failed');
                        }
                    }
                });
            }
        }


        function handleInitializationError(error) {
            updateStatus('error', `Failed to load scripts: ${error.message}`);
            showNoScriptsMessage(`Error loading scripts: ${error.message}`);
        }

        // Make functions available globally for HTML onclick handlers
        window.saveScript = saveScript;
        window.navigateScript = navigateScript;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            init().catch(error => {
                console.error('Failed to initialize Chapter Outline Editor:', error);
            });
        });
    </script>
    
    <script type="module">
        import BottomNavigation from '../../shared/js/bottom-navigation.js';
        window.bottomNav = new BottomNavigation({
            onSave: () => window.saveScript(),
            onNavigate: (direction) => window.navigateScript(direction),
            showAutoSave: true
        });
        
        // Make the navigation update function available globally
        window.updateBottomNavigation = (currentIndex, totalItems) => {
            if (window.bottomNav) {
                window.bottomNav.updateNavigation(currentIndex, totalItems);
            }
        };
        
        // Make the unsaved changes function available globally
        window.setUnsavedChanges = (hasChanges) => {
            if (window.bottomNav) {
                window.bottomNav.setUnsavedChanges(hasChanges);
            }
        };
    </script>
</body>
</html>