<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Editor</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✉️</text></svg>">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Shared Styles -->
        <link rel="stylesheet" href="../../shared/styles/theme.css">
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/script_editor_styles.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">
</head>
<body class="has-sidebar">
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <div class="container with-sidebar">
        <div class="header">
            
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">Loading</div>
            </div>
            
            <div class="completed-today-bar">
                <div class="completed-today-text">Emails Sent Today: <span id="emailsCompletedTodayCount">0</span></div>
            </div>
            
            <h1 class="page-title">Email Newsletter Editor</h1>
        </div>

        <div id="content">
            <div class="info-section">
                <div class="script-info" id="emailInfo" style="display: none;">
                    <div class="info-item">
                        <div class="info-label">Email ID</div>
                        <div class="info-value" id="emailIdValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Campaign</div>
                        <div class="info-value" id="campaignValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Audience</div>
                        <div class="info-value" id="audienceValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Send Date</div>
                        <div class="info-value" id="sendDateValue">-</div>
                    </div>
                </div>
            </div>

            <div class="editor-section" id="emailSection" style="display: none;">
                <h2>Subject Line</h2>
                <input type="text" id="subjectLine" class="form-input" style="margin-bottom: 20px;">
                
                <h2>Preview Text</h2>
                <input type="text" id="previewText" class="form-input" style="margin-bottom: 20px;" placeholder="Text that appears in inbox preview">
                
                <h2>Email Content</h2>
                <textarea id="emailContent" class="content-textarea" rows="15"></textarea>
                
                <h3 style="margin-top: 20px;">Call to Action</h3>
                <input type="text" id="ctaText" class="form-input" placeholder="Button text">
                <input type="url" id="ctaLink" class="form-input" placeholder="https://example.com" style="margin-top: 10px;">
            </div>

            <div class="button-group" id="actionButtons" style="display: none;">
                <button class="btn btn-secondary" onclick="skipEmail()">Skip</button>
                <button class="btn btn-primary" onclick="saveAndContinue()">Save & Continue</button>
            </div>

            <div id="noEmailsMessage" style="display: none; text-align: center; padding: 40px;">
                <h2>No Emails to Review</h2>
                <p>All emails have been reviewed. Check back later for new items.</p>
            </div>
        </div>
    </div>

        <script src="../../shared/js/theme-manager.js"></script>
    <script type="module" src="../../shared/js/sidebar-component.js"></script>
    
    <script type="module">
        // Email Editor Application - Configuration-driven editor

        import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/js/config.js';
        import { updateStatus, showNoScriptsMessage, fetchWithErrorHandling } from '../../shared/js/editor-utils.js';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentEmailData = null;
        let emailsToReview = [];
        let currentEmailIndex = 0;
        let pageConfig = null;

        async function init() {
            try {
                updateStatus('loading', 'Loading page configuration...');

                // Get page configuration
                const pageName = window.location.pathname.split('/').pop().replace('.html', '');

                const { data: config, error: configError } = await supabase
                    .from('html_page_config')
                    .select('*')
                    .eq('page_name', pageName)
                    .single();

                if (configError || !config) {
                    throw new Error(`Page configuration not found for: ${pageName}`);
                }

                pageConfig = config;

                // Set page title dynamically
                document.title = pageConfig.page_title;
                const h1Element = document.querySelector('h1.page-title');
                if (h1Element) {
                    h1Element.textContent = pageConfig.page_title;
                }

                updateStatus('loading', `Loading ${pageConfig.page_title.toLowerCase()}...`);

                // Filter records using config
                const url = `${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.status_field_name}=eq.${pageConfig.display_status_id}&select=*`;
                const emails = await fetchWithErrorHandling(url);
                emailsToReview = emails;

                if (emails.length > 0) {
                    loadEmail(0);
                    updateStatus('saved', 'Loaded successfully');
                } else {
                    showNoScriptsMessage(`No ${pageConfig.page_title.toLowerCase()} to display - everything checked ✓`);
                }
            } catch (error) {
                console.error('Email Editor initialization error:', error);
                updateStatus('error', `Failed to load emails: ${error.message}`);
            }
        }

        function loadEmail(index) {
            if (index >= emailsToReview.length) {
                showNoScriptsMessage('All emails completed!');
                return;
            }

            currentEmailData = emailsToReview[index];
            currentEmailIndex = index;

            const recordId = currentEmailData[pageConfig.id_field_name];

            document.getElementById('emailIdValue').textContent = recordId || '-';
            document.getElementById('campaignValue').textContent = currentEmailData.campaign_name || '-';
            document.getElementById('audienceValue').textContent = currentEmailData.audience_segment || '-';
            document.getElementById('sendDateValue').textContent = currentEmailData.scheduled_send_date || 'Not scheduled';

            document.getElementById('subjectLine').value = currentEmailData.subject_line || '';
            document.getElementById('previewText').value = currentEmailData.preview_text || '';
            document.getElementById('emailContent').value = currentEmailData.email_content || '';
            document.getElementById('ctaText').value = currentEmailData.cta_text || '';
            document.getElementById('ctaLink').value = currentEmailData.cta_link || '';

            document.getElementById('emailInfo').style.display = 'grid';
            document.getElementById('emailSection').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex';
            document.getElementById('noEmailsMessage').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        async function saveAndContinue() {
            if (!currentEmailData) return;

            try {
                updateStatus('loading', 'Saving email...');

                const recordId = currentEmailData[pageConfig.id_field_name];
                const updateData = {
                    subject_line: document.getElementById('subjectLine').value,
                    preview_text: document.getElementById('previewText').value,
                    email_content: document.getElementById('emailContent').value,
                    cta_text: document.getElementById('ctaText').value,
                    cta_link: document.getElementById('ctaLink').value
                };

                // Update status using configuration
                if (pageConfig && pageConfig.next_status_id) {
                    updateData[pageConfig.status_field_name] = pageConfig.next_status_id;
                }

                const response = await fetch(`${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.id_field_name}=eq.${recordId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`Failed to save email: ${response.status}`);
                }

                updateStatus('saved', 'Email saved successfully');

                if (window.refreshNavigationBadges) {
                    await window.refreshNavigationBadges();
                }

                emailsToReview.splice(currentEmailIndex, 1);

                if (emailsToReview.length > 0) {
                    if (currentEmailIndex >= emailsToReview.length) currentEmailIndex = 0;
                    loadEmail(currentEmailIndex);
                } else {
                    showNoScriptsMessage('All emails completed!');
                }
            } catch (error) {
                console.error('Error saving:', error);
                updateStatus('error', `Failed to save: ${error.message}`);
            }
        }

        function skipEmail() {
            currentEmailIndex++;
            loadEmail(currentEmailIndex);
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting Email Editor...');
            init();
        });

        window.saveAndContinue = saveAndContinue;
        window.skipEmail = skipEmail;
    </script>
</body>
</html>