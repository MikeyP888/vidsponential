<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Posts Editor</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <link rel="stylesheet" href="../../shared/styles/theme.css">
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/script_editor_styles.css">
    <link rel="stylesheet" href="../../shared/styles/missing-layout.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">
    <link rel="stylesheet" href="../../shared/styles/bottom-navigation.css">
</head>
<body class="has-sidebar">
    <!-- Sticky Top Status Bar -->
    <div id="stickyStatusBar" style="
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        background: transparent;
        padding: 4px 20px;
        z-index: 999;
        display: flex;
        justify-content: space-between;
        align-items: center;
        pointer-events: none;
    ">
        <!-- Script Info Pill (Left) -->
        <div id="stickyScriptInfo" style="
            background: white;
            padding: 3.6px 10.8px;
            border-radius: 18px;
            font-size: 10.8px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            pointer-events: auto;
            display: none;
        ">-</div>

        <!-- Status Indicator Pill (Right) -->
        <div class="status-indicator" id="stickyStatusIndicator" style="pointer-events: auto;">Loading</div>
    </div>

    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>

    <div class="container with-sidebar" style="padding-top: 30px;">
        <!-- =============================================== -->
        <!--                 HEADER SECTION                -->
        <!-- =============================================== -->
        <div class="header">
            
            <!-- Status bar removed - now in sticky top bar -->

            <!-- Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Script Chapters Completed Today: <span id="chaptersCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Fourth horizontal container: Overall Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Scripts Completed Today: <span id="scriptsCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Page Title -->
            <h1 class="page-title">Social Posts Editor</h1>
        </div>

        <!-- =============================================== -->
        <!--                 MAIN CONTENT                  -->
        <!-- =============================================== -->
        <div id="content">
            <!-- Script Info Section -->
            <div id="scriptInfoBox"></div>
            <!-- Working Headline and Primary Keyword Fields -->
            <div class="main-fields">
                <!-- Working Headline Section -->
                <div class="headline-options">
                    <h2 class="section-title">Headline</h2>
                    <div class="chapter-se-7a2807fb2c0d">
                        <!-- Working Headline Row -->
                        <div class="ch-title-7a2807fb2c0f">
                            <!-- Headline Text + Label -->
                            <div class="title-la-7a2807fb2c1a">
                                <label class="label-ch-7a2807fb2c1f">Headline:</label>
                                <div class="title-fiel-7a2807fb2c1e">
                                    <textarea class="chapter-ti-7a2807fb2c20" id="workingHeadline" placeholder="Enter the working headline..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Headline Rating + Label -->
                            <div class="title-rating-l-7a2807fb2c19">
                                <label class="label-rat-7a2807fb2c1c">Rating / 100:</label>
                                <div class="rating-fie-7a2807fb2c1b">
                                    <input type="number" class="rating-7a2807fb2c1d" id="workingHeadlineRating" data-field="script_headline_rating" min="1" max="100" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Primary Keyword Section -->
                <div class="headline-options">
                    <h2 class="section-title">Primary Keyword</h2>
                    <div class="chapter-se-7a2807fb2c0d">
                        <!-- Primary Keyword Row -->
                        <div class="ch-title-7a2807fb2c0f">
                            <!-- Keyword Text + Label -->
                            <div class="title-la-7a2807fb2c1a">
                                <label class="label-ch-7a2807fb2c1f">Primary Keyword:</label>
                                <div class="title-fiel-7a2807fb2c1e">
                                    <input type="text" class="chapter-ti-7a2807fb2c20" id="primaryKeyword" placeholder="Enter the primary keyword...">
                                </div>
                            </div>
                            
                            <!-- Keyword Rating + Label -->
                            <div class="title-rating-l-7a2807fb2c19">
                                <label class="label-rat-7a2807fb2c1c">Rating / 100:</label>
                                <div class="rating-fie-7a2807fb2c1b">
                                    <input type="number" class="rating-7a2807fb2c1d" id="primaryKeywordRating" data-field="primary_keyword_rating" min="1" max="100" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Chapter Outlines Section -->
            <div class="chapters-section">
                <h2 class="section-title">Chapters</h2>
                <div id="chaptersList"></div>
            </div>
        </div>

        <!-- =============================================== -->
        <!--                 NO SCRIPTS MESSAGE            -->
        <!-- =============================================== -->
        <div id="noScriptsMessage" class="message" style="display: none;">
            No script outlines to display - everything checked ‚úì
        </div>

        <!-- Bottom navigation will be added by JavaScript -->
    </div>

        <script src="../../shared/js/theme-manager.js"></script>
    <script type="module" src="../../shared/js/sidebar-component.js"></script>
    <script type="module" src="../../shared/js/textarea-autosize.js"></script>
    <script type="module">
        // Social Posts Editor Application - Configuration-driven editor

        import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/js/config.js';
        import { updateStatus, showNoScriptsMessage, fetchWithErrorHandling } from '../../shared/js/editor-utils.js';
        import { loadRatings, saveRatings, collectRatingValues, populateRatingFields } from '../../shared/js/rating-utils.js';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let postsToReview = [];
        let currentPostIndex = 0;
        let hasUnsavedChanges = false;
        let isLoading = false;
        let pageConfig = null;
        let currentData = null;

        async function init() {
            try {
                updateStatus('loading', 'Loading page configuration...');

                // Get page configuration
                const pageName = window.location.pathname.split('/').pop().replace('.html', '');

                const { data: config, error: configError } = await supabase
                    .from('html_page_config')
                    .select('*')
                    .eq('page_name', pageName)
                    .single();

                if (configError || !config) {
                    throw new Error(`Page configuration not found for: ${pageName}`);
                }

                pageConfig = config;

                // Set page title dynamically
                document.title = pageConfig.page_title;
                const h1Element = document.querySelector('h1.page-title');
                if (h1Element) {
                    h1Element.textContent = pageConfig.page_title;
                }

                updateStatus('loading', `Loading ${pageConfig.page_title.toLowerCase()}...`);

                // Filter records using config
                const url = `${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.status_field_name}=eq.${pageConfig.display_status_id}&select=${pageConfig.id_field_name},${pageConfig.status_table_name === 'social_posts' ? 'social_post_headline' : 'headline'}`;
                const posts = await fetchWithErrorHandling(url);
                postsToReview = posts;
                
                if (posts.length > 0) {
                    await loadCurrentPostData();
                    setupEventListeners();
                    startAutoSave();
                } else {
                    showNoScriptsMessage('There are no social posts ready for editing at this time.');
                }
            } catch (error) {
                console.error('Social Posts Editor initialization error:', error);
                updateStatus('error', `Failed to load social posts: ${error.message}`);
            }
        }

        async function loadCurrentPostData() {
            if (postsToReview.length === 0) return;

            const recordId = postsToReview[currentPostIndex][pageConfig.id_field_name];

            try {
                const recordInfo = await loadRecordInfo(recordId);

                // Load ratings from centralized system
                const ratings = await loadRatings('social_posts', recordId, [
                    'social_post',
                    'social_post_headline'
                ]);

                // Store in currentData
                currentData = { post: recordInfo, ratings: ratings };

                displayPostData(currentData);
                updateNavigationButtons();
                updateStatus('saved', 'Loaded successfully');
            } catch (error) {
                console.error(`Error loading ${pageConfig.status_table_name}:`, error);
                updateStatus('error', `Failed to load ${pageConfig.status_table_name} data`);
            }
        }

        // Load record data from configured table
        async function loadRecordInfo(recordId) {
            console.log(`Loading ${pageConfig.status_table_name} data for ID:`, recordId);

            const response = await fetch(`${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.id_field_name}=eq.${recordId}&select=*`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });

            console.log(`${pageConfig.status_table_name} response status:`, response.status);

            if (!response.ok) {
                console.warn(`No ${pageConfig.status_table_name} data found`);
                return null;
            }

            const data = await response.json();
            console.log(`${pageConfig.status_table_name} data received:`, data);
            return data && data.length > 0 ? data[0] : null;
        }

        function displayPostData(data) {
            if (!data) return;
            document.getElementById('content').style.display = 'block';

            // Use utility function to display post info
            displayPostInfo(data.post);

            // Update sticky post info pill
            const stickyScriptInfo = document.getElementById('stickyScriptInfo');
            if (stickyScriptInfo && data.post) {
                const postId = data.post.social_post_id || '-';
                const postHeadline = data.post.social_post_headline || 'Untitled';
                stickyScriptInfo.textContent = `Post ID: ${postId} | ${postHeadline}`;
                stickyScriptInfo.style.display = 'block';
            }

            displaySocialPost(data.post);
        }

        // Display social post from the social_posts table
        function displaySocialPost(post) {
            console.log('displaySocialPost called with:', post);
            const container = document.getElementById('chaptersList');
            container.innerHTML = '';

            if (!post) {
                console.log('No post to display');
                container.innerHTML = `
                    <div class="message info">
                        <strong>No social post found</strong><br>
                        No social post data is available.
                    </div>
                `;
                return;
            }

            console.log('Displaying social post');

            const postSection = document.createElement('div');
            postSection.className = 'chapter-se-7a2807fb2c0d';

            postSection.innerHTML = `
                <!-- Social Post Header Button -->
                <button class="gradient-button">
                    <span class="gradient-button__text">Social Post ID: ${post.social_post_id || 'N/A'}</span>
                </button>

                <!-- Social Post Headline Row -->
                <div class="ch-title-7a2807fb2c0f">
                    <!-- Social Post Headline Text + Label -->
                    <div class="form-row__text-field">
                        <label class="label-ch-7a2807fb2c1f">Social Post Headline:</label>
                        <div class="title-fiel-7a2807fb2c1e">
                            <input type="text" class="chapter-ti-7a2807fb2c20"
                                   id="social_post_headline_${post.social_post_id}"
                                   data-post-id="${post.social_post_id}"
                                   data-field="social_post_headline"
                                   placeholder="Enter social post headline..."
                                   value="${post.social_post_headline || ''}">
                        </div>
                    </div>

                    <!-- Social Post Headline Rating + Label -->
                    <div class="form-row__rating-field">
                        <div class="rating-field">
                            <label class="rating-field__label">Rating / 100:</label>
                            <div class="rating-field__container">
                                <input type="number"
                                       class="rating-field__input"
                                       id="rating_social_post_headline"
                                       data-post-id="${post.social_post_id}"
                                       data-field="social_post_headline_rating"
                                       min="1" max="100"
                                       value="">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Social Post Text Content Row -->
                <div class="form-row">
                    <div class="form-row__text-field">
                        <div class="text-field-multi">
                            <div class="text-field-multi__container">
                                <textarea class="text-field-multi__input"
                                         id="social_post_text_${post.social_post_id}"
                                         data-post-id="${post.social_post_id}"
                                         data-field="social_post"
                                         style="min-height: 500px; height: 500px;"
                                         placeholder="Enter social post content...">${post.social_post || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-row__rating-field">
                        <div class="rating-field">
                            <label class="rating-field__label">Rating / 100:</label>
                            <div class="rating-field__container">
                                <input type="number"
                                       class="rating-field__input"
                                       id="rating_social_post"
                                       data-post-id="${post.social_post_id}"
                                       data-field="social_post_rating"
                                       min="1"
                                       max="100"
                                       value=""
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(postSection);

            // Populate rating fields from centralized system
            if (currentData && currentData.ratings) {
                populateRatingFields(currentData.ratings, 'rating_');
            }
        }

        // Display basic post info
        function displayPostInfo(post) {
            if (!post) return;

            // Update script info area with post information
            const scriptInfo = document.getElementById('scriptInfo');
            if (scriptInfo) {
                scriptInfo.innerHTML = `
                    <div class="info-card">
                        <h3>Social Post Information</h3>
                        <p><strong>Post ID:</strong> ${post.social_post_id || 'N/A'}</p>
                        <p><strong>Headline:</strong> ${post.social_post_headline || 'No headline'}</p>
                        <p><strong>Status ID:</strong> ${post.social_post_status_id || 'N/A'}</p>
                    </div>
                `;
                scriptInfo.style.display = 'block';
            }
        }

        async function saveScript() {
            if (isLoading) return;

            try {
                isLoading = true;
                updateStatus('loading', 'Saving social post data...');

                const postId = postsToReview[currentPostIndex].social_post_id;

                // Save social post data
                await saveSocialPostData(postId);

                updateStatus('saved', 'Social post saved successfully');
                hasUnsavedChanges = false;
                if (window.setUnsavedChanges) {
                    window.setUnsavedChanges(false);
                }

                postsToReview.splice(currentPostIndex, 1);

                if (postsToReview.length > 0) {
                    if (currentPostIndex >= postsToReview.length) currentPostIndex = 0;
                    await loadCurrentPostData();
                } else {
                    showNoScriptsMessage('All social posts completed!');
                }

            } catch (error) {
                console.error('Save error:', error);
                updateStatus('error', `Failed to save social post: ${error.message}`);
            } finally {
                isLoading = false;
            }
        }

        // Save social post data
        async function saveSocialPostData(postId) {
            const postFields = document.querySelectorAll('[data-post-id]');
            const updateData = {};

            // Collect all updates for this post
            postFields.forEach(field => {
                const fieldType = field.dataset.field;

                if (fieldType === 'social_post_headline') {
                    updateData.social_post_headline = field.value;
                } else if (fieldType === 'social_post') {
                    updateData.social_post = field.value;
                }
            });

            // Update status using configuration
            if (pageConfig && pageConfig.next_status_id) {
                updateData[pageConfig.status_field_name] = pageConfig.next_status_id;
            }

            console.log(`Saving ${pageConfig ? pageConfig.status_table_name : 'record'} ${postId} with data:`, updateData);

            const response = await fetch(`${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.id_field_name}=eq.${postId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Failed to save ${pageConfig.status_table_name} ${postId}. Response:`, response.status, errorText);
                throw new Error(`Failed to save ${pageConfig.status_table_name} ${postId}: ${response.status} - ${errorText}`);
            }

            // Save ratings to centralized system (no script_id for social posts)
            const ratingValues = collectRatingValues([
                'social_post',
                'social_post_headline'
            ], 'rating_');
            await saveRatings('social_posts', postId, ratingValues, null);
        }

        async function navigateScript(direction) {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Continue?')) return;

            const newIndex = currentPostIndex + direction;
            if (newIndex >= 0 && newIndex < postsToReview.length) {
                currentPostIndex = newIndex;
                await loadCurrentPostData();
            }
        }

        function updateNavigationButtons() {
            if (window.updateBottomNavigation) {
                window.updateBottomNavigation(currentPostIndex, postsToReview.length);
            }
        }


        // Set up event listeners
        function setupEventListeners() {
            // Add change listeners to mark unsaved changes
            document.addEventListener('input', (e) => {
                if (e.target.dataset.field && e.target.dataset.postId) {
                    hasUnsavedChanges = true;
                    if (window.setUnsavedChanges) {
                        window.setUnsavedChanges(true);
                    }
                    updateStatus('editing', 'Editing social post data...');
                }
            });
        }

        // Auto-save functionality
        function startAutoSave() {
            if (window.bottomNav) {
                window.bottomNav.startAutoSave(async () => {
                    if (hasUnsavedChanges && postsToReview.length > 0) {
                        try {
                            const postId = postsToReview[currentPostIndex].social_post_id;

                            // Save content data
                            const postFields = document.querySelectorAll('[data-post-id]');
                            const updateData = {};

                            postFields.forEach(field => {
                                const fieldType = field.dataset.field;

                                if (fieldType === 'social_post_headline') {
                                    updateData.social_post_headline = field.value;
                                } else if (fieldType === 'social_post') {
                                    updateData.social_post = field.value;
                                }
                            });

                            const response = await fetch(`${SUPABASE_URL}/rest/v1/${pageConfig.status_table_name}?${pageConfig.id_field_name}=eq.${postId}`, {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify(updateData)
                            });

                            if (!response.ok) {
                                throw new Error(`Failed to auto-save content`);
                            }

                            // Save ratings to centralized system (no script_id for social posts)
                            const ratingValues = collectRatingValues([
                                'social_post',
                                'social_post_headline'
                            ], 'rating_');
                            await saveRatings('social_posts', postId, ratingValues, null);

                            hasUnsavedChanges = false;
                            if (window.setUnsavedChanges) {
                                window.setUnsavedChanges(false);
                            }
                            updateStatus('saved', 'Auto-saved');
                        } catch (error) {
                            console.error('Auto-save failed:', error);
                            updateStatus('error', 'Auto-save failed');
                        }
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting Social Posts Editor...');
            init();
        });

        window.saveScript = saveScript;
        window.navigateScript = navigateScript;
    </script>
    
    <script type="module">
        import BottomNavigation from '../../shared/js/bottom-navigation.js';
        window.bottomNav = new BottomNavigation({
            onSave: () => window.saveScript(),
            onNavigate: (direction) => window.navigateScript(direction),
            showAutoSave: true
        });
        
        window.updateBottomNavigation = (currentIndex, totalItems) => {
            if (window.bottomNav) window.bottomNav.updateNavigation(currentIndex, totalItems);
        };
        
        window.setUnsavedChanges = (hasChanges) => {
            if (window.bottomNav) {
                window.bottomNav.setUnsavedChanges(hasChanges);
            }
        };
    </script>
</body>
</html>