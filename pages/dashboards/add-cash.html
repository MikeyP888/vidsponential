<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Cash</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’°</text></svg>">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="../../shared/styles/theme.css">
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">

    <style>
        .client-form-section {
            margin: 20px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 11px;
            font-family: "Inter", sans-serif;
            font-weight: 600;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: " *";
            color: #e74c3c;
        }

        .form-input,
        .form-select {
            padding: 12px;
            font-size: 14px;
            font-family: "Tahoma", sans-serif;
            border: 0.5px solid #5b5a5a;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #0099ff;
            box-shadow: 0 0 0 3px rgba(0, 153, 255, 0.2);
        }

        .submit-btn {
            background: linear-gradient(to right, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%);
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(11, 230, 255, 0.4);
        }

        .payments-list {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .payment-item:hover {
            background: #f0f0f0;
        }

        .payment-info {
            flex: 1;
        }

        .payment-amount {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .payment-details {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body class="has-sidebar">
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>

    <div class="container with-sidebar">
        <!-- Header Section -->
        <div class="header">
            <!-- Status Indicator -->
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">Ready</div>
            </div>

            <!-- Page Title -->
            <h1 class="page-title">Add Cash</h1>
        </div>

        <!-- Main Content -->
        <div id="content">
            <div class="client-form-section">
                <h2 class="section-title">Cash Receipt Information</h2>

                <!-- Client Selection -->
                <div class="form-group" style="margin-bottom: 20px; max-width: 50%;">
                    <label class="form-label required" for="clientSelect">Client</label>
                    <select class="form-select" id="clientSelect" onchange="if(this.value) { loadPreviousPayments(); loadLastPaymentDefaults(); }" required>
                        <option value="">Select a client...</option>
                    </select>
                </div>

                <!-- Cash Details -->
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required" for="receivedDate">Received Date</label>
                        <input type="date" class="form-input" id="receivedDate" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="amount">Amount (Â£)</label>
                        <input type="number" step="0.01" class="form-input" id="amount" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="currencySelect">Currency</label>
                        <select class="form-select" id="currencySelect">
                            <option value="">Select a currency...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="amountCurrency">Amount (Currency)</label>
                        <input type="number" step="0.01" class="form-input" id="amountCurrency" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">Description</label>
                        <input type="text" class="form-input" id="description" placeholder="Enter description">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="invoiceSelect">Invoice</label>
                        <select class="form-select" id="invoiceSelect">
                            <option value="">Select an invoice...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="receivingBankSelect">Receiving Bank</label>
                        <select class="form-select" id="receivingBankSelect">
                            <option value="">Select a receiving bank...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cashSourceSelect">Cash Source</label>
                        <select class="form-select" id="cashSourceSelect">
                            <option value="">Select a cash source...</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: right;">
                    <button class="submit-btn" onclick="addCashReceipt()">Add Cash Receipt</button>
                </div>
            </div>

            <!-- Previous Payments List -->
            <div class="payments-list">
                <h2 class="section-title">Previous Payments</h2>
                <div id="paymentsList">
                    <p style="text-align: center; color: #999;">Select a client to view previous payments</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../../shared/js/theme-manager.js"></script>
    <script type="module" src="../../shared/js/sidebar-component.js"></script>
    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/js/config.js';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing add-cash.html...');
            console.log('Supabase URL:', SUPABASE_URL);
            console.log('Supabase client initialized:', !!supabase);

            // Test connection
            try {
                const { data, error } = await supabase.from('clients').select('count');
                console.log('Test query result:', { data, error });
            } catch (e) {
                console.error('Test query failed:', e);
            }

            await loadClients();
            await loadInvoices();
            await loadReceivingBanks();
            await loadCashSources();
            await loadCurrencies();
            setDefaultReceivedDate();
            await loadGlobalDefaults();

            console.log('All initialization complete');

            // Set status back to Ready after a short delay
            setTimeout(() => {
                if (document.getElementById('statusIndicator').textContent !== 'Error loading clients') {
                    document.getElementById('statusIndicator').textContent = 'Ready';
                }
            }, 2000);
        });

        // Set default received date to today
        function setDefaultReceivedDate() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const receivedDateField = document.getElementById('receivedDate');
            receivedDateField.value = dateStr;
            console.log('Received date set to:', dateStr);
        }

        // Load clients dropdown
        async function loadClients() {
            console.log('Loading clients...');
            document.getElementById('statusIndicator').textContent = 'Loading clients...';
            try {
                const { data: clients, error } = await supabase
                    .from('clients')
                    .select('*')
                    .order('client_id', { ascending: true });

                if (error) {
                    console.error('Supabase error loading clients:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    throw error;
                }

                console.log('Clients loaded:', clients);
                console.log('Number of clients:', clients?.length);

                const clientSelect = document.getElementById('clientSelect');
                clientSelect.innerHTML = '<option value="">Select a client...</option>';

                if (clients && clients.length > 0) {
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        // Try client_full_name first, fallback to first_name + last_name
                        const displayName = client.client_full_name ||
                                          `${client.client_first_name || ''} ${client.client_last_name || ''}`.trim() ||
                                          'Unnamed Client';
                        option.textContent = `${client.client_id} - ${displayName}`;
                        clientSelect.appendChild(option);
                    });
                    console.log(`${clients.length} client options added to dropdown`);
                    document.getElementById('statusIndicator').textContent = `Loaded ${clients.length} clients`;
                } else {
                    console.warn('No clients found in database');
                    clientSelect.innerHTML = '<option value="">No clients available</option>';
                    document.getElementById('statusIndicator').textContent = 'No clients found';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                const clientSelect = document.getElementById('clientSelect');
                clientSelect.innerHTML = '<option value="">Error loading clients</option>';
                document.getElementById('statusIndicator').textContent = 'Error loading clients';
                alert('Error loading clients: ' + (error.message || 'Unknown error'));
            }
        }

        // Load invoices dropdown
        async function loadInvoices() {
            console.log('Loading invoices...');
            try {
                const { data: invoices, error } = await supabase
                    .from('acc_invoices')
                    .select('invoice_id, description')
                    .order('invoice_id', { ascending: false });

                if (error) {
                    console.error('Supabase error loading invoices:', error);
                    throw error;
                }

                console.log('Invoices loaded:', invoices);

                const invoiceSelect = document.getElementById('invoiceSelect');
                invoiceSelect.innerHTML = '<option value="">Select an invoice...</option>';

                if (invoices && invoices.length > 0) {
                    invoices.forEach(invoice => {
                        const option = document.createElement('option');
                        option.value = invoice.invoice_id;
                        option.textContent = `${invoice.invoice_id} - ${invoice.description || 'No description'}`;
                        invoiceSelect.appendChild(option);
                    });
                    console.log(`${invoices.length} invoice options added to dropdown`);
                } else {
                    console.warn('No invoices found in database');
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                console.warn('Invoice dropdown will remain empty - this is optional');
            }
        }

        // Load receiving banks dropdown
        async function loadReceivingBanks() {
            console.log('Loading receiving banks...');
            try {
                const { data: banks, error } = await supabase
                    .from('acc_receiving_banks')
                    .select('receiving_bank_id, receiving_bank_name')
                    .order('receiving_bank_id', { ascending: true });

                if (error) {
                    console.error('Supabase error loading receiving banks:', error);
                    throw error;
                }

                console.log('Receiving banks loaded:', banks);

                const bankSelect = document.getElementById('receivingBankSelect');
                bankSelect.innerHTML = '<option value="">Select a receiving bank...</option>';

                if (banks && banks.length > 0) {
                    banks.forEach(bank => {
                        const option = document.createElement('option');
                        option.value = bank.receiving_bank_id;
                        option.textContent = `${bank.receiving_bank_id} - ${bank.receiving_bank_name}`;
                        bankSelect.appendChild(option);
                    });
                    console.log(`${banks.length} receiving bank options added to dropdown`);
                } else {
                    console.warn('No receiving banks found in database');
                }
            } catch (error) {
                console.error('Error loading receiving banks:', error);
                console.warn('Receiving bank dropdown will remain empty - this is optional');
            }
        }

        // Load cash sources dropdown
        async function loadCashSources() {
            console.log('Loading cash sources...');
            try {
                const { data: sources, error } = await supabase
                    .from('acc_cash_received_sources')
                    .select('cash_received_source_id, received_source')
                    .order('cash_received_source_id', { ascending: true });

                if (error) {
                    console.error('Supabase error loading cash sources:', error);
                    throw error;
                }

                console.log('Cash sources loaded:', sources);

                const sourceSelect = document.getElementById('cashSourceSelect');
                sourceSelect.innerHTML = '<option value="">Select a cash source...</option>';

                if (sources && sources.length > 0) {
                    sources.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source.cash_received_source_id;
                        option.textContent = `${source.cash_received_source_id} - ${source.received_source}`;
                        sourceSelect.appendChild(option);
                    });
                    console.log(`${sources.length} cash source options added to dropdown`);
                } else {
                    console.warn('No cash sources found in database');
                }
            } catch (error) {
                console.error('Error loading cash sources:', error);
                console.warn('Cash source dropdown will remain empty - this is optional');
            }
        }

        // Load currencies dropdown
        async function loadCurrencies() {
            console.log('Loading currencies...');
            try {
                const { data: currencies, error } = await supabase
                    .from('acc_currencies')
                    .select('currency_id, currency')
                    .order('currency_id', { ascending: true });

                if (error) {
                    console.error('Supabase error loading currencies:', error);
                    throw error;
                }

                console.log('Currencies loaded:', currencies);

                const currencySelect = document.getElementById('currencySelect');
                currencySelect.innerHTML = '<option value="">Select a currency...</option>';

                if (currencies && currencies.length > 0) {
                    currencies.forEach(currency => {
                        const option = document.createElement('option');
                        option.value = currency.currency_id;
                        option.textContent = `${currency.currency_id} - ${currency.currency}`;
                        currencySelect.appendChild(option);
                    });
                    console.log(`${currencies.length} currency options added to dropdown`);
                } else {
                    console.warn('No currencies found in database');
                }
            } catch (error) {
                console.error('Error loading currencies:', error);
                console.warn('Currency dropdown will remain empty - this is optional');
            }
        }

        // Load previous payments for selected client
        async function loadPreviousPayments() {
            const clientId = document.getElementById('clientSelect').value;

            if (!clientId || clientId === '') {
                document.getElementById('paymentsList').innerHTML = '<p style="text-align: center; color: #999;">Select a client to view previous payments</p>';
                return;
            }

            const clientIdNum = parseInt(clientId);
            if (isNaN(clientIdNum)) {
                console.error('Invalid client ID:', clientId);
                return;
            }

            console.log('Loading previous payments for client ID:', clientIdNum);

            try {
                const { data: payments, error } = await supabase
                    .from('acc_cash_received')
                    .select(`
                        *,
                        acc_invoices(description),
                        acc_receiving_banks(receiving_bank_name),
                        acc_cash_received_sources(received_source)
                    `)
                    .eq('client_id', clientIdNum)
                    .order('cash_received_id', { ascending: false });

                if (error) throw error;

                console.log('Previous payments loaded:', payments);

                const paymentsList = document.getElementById('paymentsList');
                paymentsList.innerHTML = '';

                if (payments && payments.length > 0) {
                    payments.forEach(payment => {
                        const paymentItem = document.createElement('div');
                        paymentItem.className = 'payment-item';

                        const receivedDate = new Date(payment.received_at).toLocaleDateString('en-GB');
                        const amount = payment['amount_Â£'] ? `Â£${parseFloat(payment['amount_Â£']).toFixed(2)}` : 'N/A';
                        const description = payment.description || 'No description';
                        const invoice = payment.acc_invoices?.description || 'No invoice';
                        const bank = payment.acc_receiving_banks?.receiving_bank_name || 'No bank';
                        const source = payment.acc_cash_received_sources?.received_source || 'No source';

                        paymentItem.innerHTML = `
                            <div class="payment-info">
                                <div class="payment-amount">${amount} - ${receivedDate}</div>
                                <div class="payment-details">ID: ${payment.cash_received_id} | ${description}</div>
                                <div class="payment-details">Bank: ${bank} | Source: ${source} | Invoice: ${invoice}</div>
                            </div>
                        `;
                        paymentsList.appendChild(paymentItem);
                    });
                } else {
                    paymentsList.innerHTML = '<p style="text-align: center; color: #999;">No previous payments for this client</p>';
                }

            } catch (error) {
                console.error('Error loading previous payments:', error);
            }
        }

        // Load global defaults from last payment (regardless of client)
        async function loadGlobalDefaults() {
            try {
                const { data: lastPayment, error } = await supabase
                    .from('acc_cash_received')
                    .select('description, receiving_bank_id, cash_received_source_id, currency_id, amount_currency')
                    .order('cash_received_id', { ascending: false })
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows returned"
                    throw error;
                }

                if (lastPayment) {
                    console.log('Pre-filling from global last payment:', lastPayment);

                    // Pre-fill description
                    if (lastPayment.description) {
                        document.getElementById('description').value = lastPayment.description;
                    }

                    // Pre-fill receiving bank
                    if (lastPayment.receiving_bank_id) {
                        document.getElementById('receivingBankSelect').value = lastPayment.receiving_bank_id;
                    }

                    // Pre-fill cash source
                    if (lastPayment.cash_received_source_id) {
                        document.getElementById('cashSourceSelect').value = lastPayment.cash_received_source_id;
                    }

                    // Pre-fill currency
                    if (lastPayment.currency_id) {
                        document.getElementById('currencySelect').value = lastPayment.currency_id;
                    }

                    // Pre-fill amount currency
                    if (lastPayment.amount_currency) {
                        document.getElementById('amountCurrency').value = lastPayment.amount_currency;
                    }
                } else {
                    console.log('No previous payments found in database');
                }
            } catch (error) {
                console.error('Error loading global defaults:', error);
            }
        }

        // Load defaults from last payment for the selected client
        async function loadLastPaymentDefaults() {
            const clientId = document.getElementById('clientSelect').value;

            if (!clientId || clientId === '') {
                return;
            }

            const clientIdNum = parseInt(clientId);
            if (isNaN(clientIdNum)) {
                return;
            }

            try {
                const { data: lastPayment, error } = await supabase
                    .from('acc_cash_received')
                    .select('description, receiving_bank_id, cash_received_source_id, currency_id, amount_currency')
                    .eq('client_id', clientIdNum)
                    .order('cash_received_id', { ascending: false })
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows returned"
                    throw error;
                }

                if (lastPayment) {
                    console.log('Pre-filling from last payment for client:', lastPayment);

                    // Pre-fill description
                    if (lastPayment.description) {
                        document.getElementById('description').value = lastPayment.description;
                    }

                    // Pre-fill receiving bank
                    if (lastPayment.receiving_bank_id) {
                        document.getElementById('receivingBankSelect').value = lastPayment.receiving_bank_id;
                    }

                    // Pre-fill cash source
                    if (lastPayment.cash_received_source_id) {
                        document.getElementById('cashSourceSelect').value = lastPayment.cash_received_source_id;
                    }

                    // Pre-fill currency
                    if (lastPayment.currency_id) {
                        document.getElementById('currencySelect').value = lastPayment.currency_id;
                    }

                    // Pre-fill amount currency
                    if (lastPayment.amount_currency) {
                        document.getElementById('amountCurrency').value = lastPayment.amount_currency;
                    }
                } else {
                    console.log('No previous payment found for this client, will use global defaults');
                    // If no payment for this client, load global defaults
                    await loadGlobalDefaults();
                }
            } catch (error) {
                console.error('Error loading last payment defaults:', error);
            }
        }

        // Add new cash receipt
        async function addCashReceipt() {
            const clientId = document.getElementById('clientSelect').value;
            const receivedDate = document.getElementById('receivedDate').value;
            const amount = document.getElementById('amount').value;
            const currencyId = document.getElementById('currencySelect').value;
            const amountCurrency = document.getElementById('amountCurrency').value;
            const description = document.getElementById('description').value.trim();
            const invoiceId = document.getElementById('invoiceSelect').value;
            const receivingBankId = document.getElementById('receivingBankSelect').value;
            const cashSourceId = document.getElementById('cashSourceSelect').value;

            // Validate required fields
            if (!clientId) {
                alert('Please select a client');
                return;
            }

            if (!receivedDate) {
                alert('Please enter a received date');
                return;
            }

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            try {
                document.getElementById('statusIndicator').textContent = 'Saving...';

                // Build the insert object
                const insertData = {
                    client_id: parseInt(clientId),
                    received_at: receivedDate,
                    'amount_Â£': parseFloat(amount)
                };

                // Only add optional fields if they have values
                if (description) insertData.description = description;
                if (invoiceId) insertData.invoice_id = parseInt(invoiceId);
                if (receivingBankId) insertData.receiving_bank_id = parseInt(receivingBankId);
                if (cashSourceId) insertData.cash_received_source_id = parseInt(cashSourceId);
                if (currencyId) insertData.currency_id = parseInt(currencyId);
                if (amountCurrency) insertData.amount_currency = parseFloat(amountCurrency);

                console.log('Inserting cash receipt with data:', insertData);

                const { data, error } = await supabase
                    .from('acc_cash_received')
                    .insert([insertData]);

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw error;
                }

                // Update status
                document.getElementById('statusIndicator').textContent = 'Cash receipt added successfully! Refreshing...';

                // Reload the page to show fresh data with defaults from last entry
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('Error adding cash receipt:', error);
                alert('Error adding cash receipt: ' + error.message);
                document.getElementById('statusIndicator').textContent = 'Error adding cash receipt';
                setTimeout(() => {
                    document.getElementById('statusIndicator').textContent = 'Ready';
                }, 3000);
            }
        }

        // Make functions available globally for HTML onclick handlers
        window.addCashReceipt = addCashReceipt;
        window.loadPreviousPayments = loadPreviousPayments;
        window.loadLastPaymentDefaults = loadLastPaymentDefaults;
    </script>
</body>
</html>
