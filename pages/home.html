<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Vidsponential</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">

    <link rel="stylesheet" href="../shared/styles/theme.css">
    <link rel="stylesheet" href="../shared/styles/base.css">
    <link rel="stylesheet" href="../shared/styles/fonts.css">
    <link rel="stylesheet" href="../shared/styles/layout.css">
    <link rel="stylesheet" href="../shared/styles/buttons.css">
    <link rel="stylesheet" href="../shared/styles/sidebar.css">

    <style>
        body {
            background: #f8f9fa;
            font-family: "Inter", sans-serif;
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .dashboard-logo {
            height: 40px;
            width: auto;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        /* Date Controls */
        .date-controls {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .period-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: "Inter", sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s ease;
        }

        .period-btn:hover {
            border-color: #3498db;
            color: #3498db;
        }

        .period-btn.active {
            background: linear-gradient(to right, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%);
            border-color: transparent;
            color: white;
        }

        .navigation-arrows {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-arrow {
            width: 32px;
            height: 32px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .nav-arrow:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .nav-arrow svg {
            width: 16px;
            height: 16px;
            stroke: #666;
        }

        .current-period {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            min-width: 180px;
            text-align: center;
        }

        /* Main Stats */
        .main-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card.scripts {
            background: linear-gradient(135deg, #2B6454 0%, #095023 100%);
            color: white;
        }

        .stat-card.clients {
            background: linear-gradient(135deg, #035062 0%, #0D3163 100%);
            color: white;
        }

        .stat-card.cash {
            background: linear-gradient(135deg, #612C2F 0%, #5B171D 100%);
            color: white;
        }

        .stat-card.hours {
            background: linear-gradient(135deg, #645F33 0%, #645A1F 100%);
            color: white;
        }

        .stat-label {
            font-size: 15px;
            font-weight: 600;
            opacity: 0.95;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-comparison {
            font-size: 15px;
            opacity: 0.85;
        }

        /* Historical Data List */
        .historical-list {
            background: white;
            border-radius: 8px;
            margin-top: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .historical-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            background: #f8f9fa;
            transition: background 0.2s ease;
        }

        .historical-item:last-child {
            margin-bottom: 0;
        }

        .historical-item:hover {
            background: #e9ecef;
        }

        .historical-label {
            font-size: 16px;
            font-weight: 500;
            color: #495057;
        }

        .historical-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }


        /* Section Titles */
        .section-title-header {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin: 24px 0 16px 0;
            padding-left: 12px;
            border-left: 4px solid;
            border-image: linear-gradient(to bottom, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%) 1;
        }

        /* Period Stats Grid */
        .period-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .mini-stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .mini-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .mini-stat-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .mini-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
        }

        /* Total Stats Grid */
        .total-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .total-stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .total-stat-card:hover {
            border-color: #3498db;
        }

        .total-stat-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(to right, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-breakdown {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        @media (max-width: 1200px) {
            .main-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-stats {
                grid-template-columns: 1fr;
            }

            .dashboard-container {
                padding: 20px;
            }

            .date-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .period-selector {
                flex-wrap: wrap;
            }

            .stat-value {
                font-size: 40px;
            }
        }
    </style>
</head>
<body class="has-sidebar">
    <div id="sidebarContainer"></div>

    <main class="dashboard-container with-sidebar">
        <div class="dashboard-header">
            <img src="../shared/assets/vidsponential logo.png" alt="Vidsponential" class="dashboard-logo">
            <h1 class="dashboard-title">Business Dashboard</h1>
        </div>

        <!-- Date Controls -->
        <div class="date-controls">
            <div class="period-selector">
                <button class="period-btn" data-period="day">Today</button>
                <button class="period-btn active" data-period="week">This Week</button>
                <button class="period-btn" data-period="month">This Month</button>
                <button class="period-btn" data-period="quarter">This Quarter</button>
                <button class="period-btn" data-period="year">This Year</button>
            </div>

            <div class="navigation-arrows">
                <button class="nav-arrow" id="prevPeriod">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15,18 9,12 15,6"></polyline>
                    </svg>
                </button>
                <div class="current-period" id="currentPeriod">Week of Oct 7 - Oct 13</div>
                <button class="nav-arrow" id="nextPeriod">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9,18 15,12 9,6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Stats -->
        <div class="main-stats">
            <div class="stat-card cash">
                <div class="stat-label">Cash Received</div>
                <div class="stat-value" id="cashValue">--</div>
                <div class="stat-comparison" id="cashComparison">Loading...</div>
                <div class="historical-list" id="cashHistory">
                    <!-- Historical data will be populated here -->
                </div>
            </div>

            <div class="stat-card hours">
                <div class="stat-label">Hours Worked</div>
                <div class="stat-value" id="hoursValue">--</div>
                <div class="stat-comparison" id="hoursComparison">Loading...</div>
                <div class="historical-list" id="hoursHistory">
                    <!-- Historical data will be populated here -->
                </div>
            </div>

            <div class="stat-card scripts">
                <div class="stat-label">Scripts Completed</div>
                <div class="stat-value" id="scriptsValue">--</div>
                <div class="stat-comparison" id="scriptsComparison">Loading...</div>
                <div class="historical-list" id="scriptsHistory">
                    <!-- Historical data will be populated here -->
                </div>
            </div>

            <div class="stat-card clients">
                <div class="stat-label">New Clients</div>
                <div class="stat-value" id="clientsValue">--</div>
                <div class="stat-comparison" id="clientsComparison">Loading...</div>
                <div class="historical-list" id="clientsHistory">
                    <!-- Historical data will be populated here -->
                </div>
            </div>
        </div>

        <!-- Content Section -->
        <h2 class="section-title-header" id="contentTitle">Content - This Week</h2>
        <div class="period-stats-grid">
            <div class="mini-stat-card">
                <div class="mini-stat-label">Social Posts</div>
                <div class="mini-stat-value" id="socialPosts">--</div>
            </div>

            <div class="mini-stat-card">
                <div class="mini-stat-label">Tweets</div>
                <div class="mini-stat-value" id="tweets">--</div>
            </div>

            <div class="mini-stat-card">
                <div class="mini-stat-label">Articles Published</div>
                <div class="mini-stat-value" id="articlesPublished">--</div>
            </div>

            <div class="mini-stat-card">
                <div class="mini-stat-label">Book Sections</div>
                <div class="mini-stat-value" id="bookSections">--</div>
            </div>
        </div>

        <!-- Scripts Due Section -->
        <h2 class="section-title-header" id="scriptsTitle">Scripts Due - This Week</h2>
        <div class="period-stats-grid">
            <div class="mini-stat-card">
                <div class="mini-stat-label">Scripts Due</div>
                <div class="mini-stat-value" id="scriptsDue">--</div>
            </div>
        </div>

        <!-- Total Stats -->
        <h2 class="section-title-header">In Total</h2>
        <div class="total-stats-grid">
            <div class="total-stat-card">
                <div class="total-stat-label">Active Clients</div>
                <div class="total-stat-value" id="activeClients">--</div>
            </div>

            <div class="total-stat-card">
                <div class="total-stat-label">Scripts by Status</div>
                <div class="total-stat-value" id="totalScripts">--</div>
                <div class="status-breakdown" id="statusBreakdown"></div>
            </div>
        </div>
    </main>

    <script src="../shared/js/theme-manager.js"></script>
    <script type="module" src="../shared/js/sidebar-component.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../shared/js/config.js';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Dashboard State
        let currentPeriodType = 'week';
        let currentOffset = 0; // 0 = current period, -1 = previous, 1 = next

        // Period definitions
        const periods = {
            day: { label: 'Day', comparison: 'Average Last 7 Days' },
            week: { label: 'Week', comparison: 'Average Last 7 Weeks' },
            month: { label: 'Month', comparison: 'Average Last 7 Months' },
            quarter: { label: 'Quarter', comparison: 'Average Last 7 Quarters' },
            year: { label: 'Year', comparison: 'Average Last 7 Years' }
        };

        // Format date range for display
        function formatDateRange(periodType, offset = 0) {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const fullMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            let start, end;

            switch(periodType) {
                case 'day':
                    start = new Date(now);
                    start.setDate(start.getDate() + offset);
                    if (offset === 0) return 'Today';
                    if (offset === -1) return 'Yesterday';
                    return `${months[start.getMonth()]} ${start.getDate()}, ${start.getFullYear()}`;

                case 'week':
                    start = new Date(now);
                    const dayOfWeek = start.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    start.setDate(start.getDate() + daysToMonday + (offset * 7));
                    end = new Date(start);
                    end.setDate(end.getDate() + 6);
                    if (offset === 0) {
                        return `Week of ${months[start.getMonth()]} ${start.getDate()} - ${months[end.getMonth()]} ${end.getDate()}`;
                    }
                    return `Week of ${months[start.getMonth()]} ${start.getDate()} - ${months[end.getMonth()]} ${end.getDate()}, ${start.getFullYear()}`;

                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth() + offset, 1);
                    return `${months[start.getMonth()]} ${start.getFullYear()}`;

                case 'quarter':
                    const quarterMonth = Math.floor(now.getMonth() / 3) * 3 + (offset * 3);
                    start = new Date(now.getFullYear(), quarterMonth, 1);
                    const quarter = Math.floor(start.getMonth() / 3) + 1;
                    return `Q${quarter} ${start.getFullYear()}`;

                case 'year':
                    return `${now.getFullYear() + offset}`;
            }
        }

        // Format label for historical list items
        function formatHistoricalLabel(periodType, offset = 0) {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const fullMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let start;

            switch(periodType) {
                case 'day':
                    start = new Date(now);
                    start.setDate(start.getDate() + offset);
                    return `${days[start.getDay()]} ${months[start.getMonth()]} ${start.getDate()}`;

                case 'week':
                    start = new Date(now);
                    const dayOfWeek = start.getDay();
                    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    start.setDate(start.getDate() + daysToMonday + (offset * 7));
                    return `Week of ${months[start.getMonth()]} ${start.getDate()}`;

                case 'month':
                    start = new Date(now.getFullYear(), now.getMonth() + offset, 1);
                    return `${fullMonths[start.getMonth()]}`;

                case 'quarter':
                    const quarterMonth = Math.floor(now.getMonth() / 3) * 3 + (offset * 3);
                    start = new Date(now.getFullYear(), quarterMonth, 1);
                    const quarter = Math.floor(start.getMonth() / 3) + 1;
                    return `Q${quarter} ${start.getFullYear()}`;

                case 'year':
                    return `${now.getFullYear() + offset}`;
            }
        }

        // Fetch dashboard data from Supabase for a specific period
        async function fetchDashboardData(offset = currentOffset) {
            try {
                const { data, error } = await supabase.rpc('get_dashboard_metrics', {
                    period_type: currentPeriodType,
                    period_offset: offset,
                    num_periods_for_graph: 7
                });

                if (error) throw error;

                return data;
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                return null;
            }
        }

        // Fetch historical data for the last 7 periods
        async function fetchHistoricalData() {
            const historicalPromises = [];

            // Fetch data for the last 7 periods (including current)
            for (let i = 0; i < 7; i++) {
                const offset = currentOffset - i;
                historicalPromises.push(fetchDashboardData(offset));
            }

            try {
                const results = await Promise.all(historicalPromises);
                return results.map((result, index) => {
                    const offset = currentOffset - index;
                    return {
                        offset: offset,
                        data: result?.current_period || null
                    };
                });
            } catch (error) {
                console.error('Error fetching historical data:', error);
                return [];
            }
        }

        // Populate historical list with fetched data
        async function populateHistoricalList(containerId, historicalData, field, formatValue = (val) => val || 0) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!historicalData || historicalData.length === 0) {
                container.innerHTML = '<div class="historical-item"><div class="historical-label">No data</div></div>';
                return;
            }

            const html = historicalData.map(({ offset, data }) => {
                const label = formatHistoricalLabel(currentPeriodType, offset);

                let value;
                if (field === 'total_hours') {
                    // Special handling for hours
                    value = data?.hours?.total || 0;
                } else {
                    value = data?.[field] || 0;
                }

                const formattedValue = formatValue(value);

                return `
                    <div class="historical-item">
                        <div class="historical-label">${label}</div>
                        <div class="historical-value">${formattedValue}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Update dashboard with data
        async function updateDashboard() {
            const period = periods[currentPeriodType];

            // Update period label
            document.getElementById('currentPeriod').textContent = formatDateRange(currentPeriodType, currentOffset);

            // Update section titles
            const periodTitles = {
                day: 'Today',
                week: 'This Week',
                month: 'This Month',
                quarter: 'This Quarter',
                year: 'This Year'
            };
            document.getElementById('contentTitle').textContent = `Content - ${periodTitles[currentPeriodType]}`;
            document.getElementById('scriptsTitle').textContent = `Scripts Due - ${periodTitles[currentPeriodType]}`;

            // Fetch current period data from Supabase
            const data = await fetchDashboardData();

            // Fetch and populate historical data for all 4 metrics
            const historicalData = await fetchHistoricalData();

            // Calculate averages from the last 7 periods (excluding current period at index 0)
            const calculateAverage = (historicalData, field) => {
                if (!historicalData || historicalData.length < 2) return 0;

                // Skip index 0 (current period), take the next 7 periods
                const last7 = historicalData.slice(1, 8);

                const sum = last7.reduce((total, item) => {
                    let value = 0;
                    if (field === 'total_hours') {
                        value = item.data?.hours?.total || 0;
                    } else {
                        value = item.data?.[field] || 0;
                    }
                    return total + value;
                }, 0);

                return sum / Math.min(last7.length, 7);
            };

            const avgScripts = calculateAverage(historicalData, 'scripts_completed');
            const avgClients = calculateAverage(historicalData, 'new_clients');
            const avgCash = calculateAverage(historicalData, 'cash_received');
            const avgHours = calculateAverage(historicalData, 'total_hours');

            if (data && data.current_period) {
                const current = data.current_period;

                // Update scripts completed
                document.getElementById('scriptsValue').textContent = current.scripts_completed || 0;
                document.getElementById('scriptsComparison').textContent = `${period.comparison}: ${avgScripts.toFixed(1)}`;

                // Update new clients
                document.getElementById('clientsValue').textContent = current.new_clients || 0;
                document.getElementById('clientsComparison').textContent = `${period.comparison}: ${avgClients.toFixed(1)}`;

                // Update cash received
                const cashReceived = current.cash_received || 0;
                document.getElementById('cashValue').textContent = `$${cashReceived.toLocaleString()}`;
                document.getElementById('cashComparison').textContent = `${period.comparison}: $${avgCash.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;

                // Update hours worked (total)
                const totalHours = current.hours ? current.hours.total : 0;
                document.getElementById('hoursValue').textContent = totalHours.toFixed(1);
                document.getElementById('hoursComparison').textContent = `${period.comparison}: ${avgHours.toFixed(1)}`;

                // Update content metrics
                document.getElementById('socialPosts').textContent = current.social_posts || 0;
                document.getElementById('tweets').textContent = current.tweets || 0;
                document.getElementById('articlesPublished').textContent = current.articles || 0;
                document.getElementById('bookSections').textContent = current.book_sections || 0;

                // Update scripts due
                document.getElementById('scriptsDue').textContent = current.scripts_due || 0;

                // Update total stats
                document.getElementById('activeClients').textContent = current.active_clients_count || 0;

                // Update scripts by status
                if (current.scripts_by_status && current.scripts_by_status.length > 0) {
                    const totalScripts = current.scripts_by_status.reduce((sum, item) => sum + item.count, 0);
                    document.getElementById('totalScripts').textContent = totalScripts;

                    const statusHtml = current.scripts_by_status
                        .map(item => `<div class="status-item"><span>${item.status}</span><span>${item.count}</span></div>`)
                        .join('');
                    document.getElementById('statusBreakdown').innerHTML = statusHtml;
                } else {
                    document.getElementById('totalScripts').textContent = '0';
                    document.getElementById('statusBreakdown').innerHTML = '';
                }
            }

            await populateHistoricalList('scriptsHistory', historicalData, 'scripts_completed');
            await populateHistoricalList('clientsHistory', historicalData, 'new_clients');
            await populateHistoricalList('cashHistory', historicalData, 'cash_received', (val) => `$${(val || 0).toLocaleString()}`);
            await populateHistoricalList('hoursHistory', historicalData, 'total_hours', (val) => (val || 0).toFixed(1));
        }

        // Period button handlers
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriodType = btn.dataset.period;
                currentOffset = 0;
                updateDashboard();
            });
        });

        // Navigation arrow handlers
        document.getElementById('prevPeriod').addEventListener('click', () => {
            currentOffset--;
            updateDashboard();
        });

        document.getElementById('nextPeriod').addEventListener('click', () => {
            currentOffset++;
            updateDashboard();
        });

        // Initialize dashboard
        updateDashboard();
    </script>
</body>
</html>