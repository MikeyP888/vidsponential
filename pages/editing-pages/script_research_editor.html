<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Research Editor</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/script_editor_styles.css">
    <link rel="stylesheet" href="../../shared/styles/missing-layout.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">
    <link rel="stylesheet" href="../../shared/styles/bottom-navigation.css">
</head>
<body class="has-sidebar">
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <div class="container with-sidebar">
        <!-- =============================================== -->
        <!--                 HEADER SECTION                -->
        <!-- =============================================== -->
        <div class="header">
            
            <!-- Second horizontal container: Status Indicator -->
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">Loading</div>
            </div>
            
            <!-- Third horizontal container: Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Script Research Completed Today: <span id="researchCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Fourth horizontal container: Overall Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Scripts Completed Today: <span id="scriptsCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Page Title -->
            <h1 class="page-title">Script Research Editor</h1>
        </div>

        <!-- =============================================== -->
        <!--                 MAIN CONTENT                  -->
        <!-- =============================================== -->
        <div id="content">
            <!-- Script Info Section -->
            <div class="info-section">
                <div class="script-info" id="scriptInfo" style="display: none;">
                    <div class="info-item">
                        <div class="info-label">Script ID</div>
                        <div class="info-value" id="scriptIdValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Words</div>
                        <div class="info-value" id="wordsValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Client</div>
                        <div class="info-value" id="clientValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Channel</div>
                        <div class="info-value" id="channelValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Type</div>
                        <div class="info-value" id="typeValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Genre</div>
                        <div class="info-value" id="genreValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Subgenre</div>
                        <div class="info-value" id="subgenreValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Format</div>
                        <div class="info-value" id="formatValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Structure</div>
                        <div class="info-value" id="structureValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Research Depth</div>
                        <div class="info-value" id="researchValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tone</div>
                        <div class="info-value" id="toneValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Angle</div>
                        <div class="info-value" id="angleValue">-</div>
                    </div>
                </div>
            </div>

            <!-- Research Content Section -->
            <div class="research-section">
                <div id="researchList">
                    <!-- Research fields will be populated here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- No Scripts Message -->
        <div id="noScriptsMessage" class="message" style="display: none;"></div>

        <!-- Bottom navigation will be added by JavaScript -->
    </div>

    <script type="module" src="../../../../../shared/js/sidebar-component.js"></script>
    <script type="module" src="../../../../../shared/js/textarea-autosize.js"></script>
    <script type="module">
        import BottomNavigation from '../../../../../shared/js/bottom-navigation.js';
        window.bottomNav = new BottomNavigation({
            onSave: () => window.saveScript(),
            onNavigate: (direction) => window.navigateScript(direction),
            showAutoSave: true
        });
        
        // Make the navigation update function available globally
        window.updateBottomNavigation = (currentIndex, totalItems) => {
            if (window.bottomNav) {
                window.bottomNav.updateNavigation(currentIndex, totalItems);
            }
        };
        
        // Make the unsaved changes function available globally
        window.setUnsavedChanges = (hasChanges) => {
            if (window.bottomNav) {
                window.bottomNav.setUnsavedChanges(hasChanges);
            }
        };
    </script>
    <script>
        // Research Editor Application
        
        // Configuration
        const SUPABASE_URL = 'https://euzbpslzrimyokzvgbzk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1emJwc2x6cmlteW9renZnYnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NDk5MTUsImV4cCI6MjA2NjEyNTkxNX0.HBznM8FVX0VnYBN8rTu6T-QOPmq0d60syavTCADl3JI';
        
        // Application state
        let currentScriptData = null;
        let scriptsToReview = [];
        let currentScriptIndex = 0;
        let autoSaveTimer = null;
        let isLoading = false;
        let hasUnsavedChanges = false;

        // Research fields configuration
        const RESEARCH_FIELDS = [
            { name: 'story_summary', label: 'STORY SUMMARY' },
            { name: 'story_foundation', label: 'STORY FOUNDATION' },
            { name: 'key_details', label: 'KEY DETAILS' },
            { name: 'dramatic_elements', label: 'DRAMATIC ELEMENTS' },
            { name: 'timeline', label: 'TIMELINE' },
            { name: 'key_players', label: 'KEY PLAYERS' },
            { name: 'individual_stories', label: 'INDIVIDUAL STORIES' },
            { name: 'quotes', label: 'QUOTES' },
            { name: 'refinement_notes', label: 'REFINEMENT NOTES' }
        ];

        // Initialize the application
        async function init() {
            try {
                console.log('=== RESEARCH EDITOR DEBUG: Starting initialization ===');
                updateStatus('loading', 'Loading scripts...');
                
                // First, let's check what scripts exist in the database
                await debugCheckAllScripts();
                
                // Load scripts with status_id = 12 (ready for research)
                const scripts = await loadScriptsToReview();
                console.log('Loaded research scripts:', scripts);
                
                scriptsToReview = scripts;
                
                if (scripts.length > 0) {
                    console.log('Loading first script with ID:', scripts[0].script_id);
                    await loadCurrentScriptData();
                    setupEventListeners();
                    startAutoSave();
                } else {
                    showNoScriptsMessage();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                handleInitializationError(error);
            }
        }

        // Debug function to check all scripts and their status
        async function debugCheckAllScripts() {
            console.log('=== DEBUG: Checking ALL scripts in database ===');
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/scripts?select=script_id,script_status_id,script_headline&order=script_id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const allScripts = await response.json();
                    console.log('Total scripts in database:', allScripts.length);
                    console.log('All scripts with their status_id:', allScripts);
                    
                    // Check specifically for status_id = 12
                    const status12Scripts = allScripts.filter(s => s.script_status_id === 12);
                    console.log('Scripts with status_id = 12:', status12Scripts);
                    
                    // Show first 5 scripts as sample
                    console.log('Sample of first 5 scripts:', allScripts.slice(0, 5));
                } else {
                    console.error('Failed to fetch all scripts:', response.status);
                }
            } catch (error) {
                console.error('Error checking all scripts:', error);
            }
        }

        // Load scripts that need research (status 12)
        async function loadScriptsToReview() {
            console.log('=== DEBUG: Fetching scripts with script_status_id=12 ===');
            console.log('URL:', `${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.12&select=script_id,script_headline`);
            
            const response = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.12&select=script_id,script_headline`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to load scripts:', response.status, errorText);
                throw new Error(`Failed to load scripts: ${response.status} - ${errorText}`);
            }

            const scripts = await response.json();
            console.log('=== DEBUG: Scripts found with status_id=12:', scripts);
            console.log('Number of scripts:', scripts.length);
            if (scripts.length > 0) {
                console.log('First script:', scripts[0]);
            }
            return scripts;
        }

        // Load current script data and research
        async function loadCurrentScriptData() {
            if (scriptsToReview.length === 0) {
                showNoScriptsMessage();
                return;
            }

            const scriptId = scriptsToReview[currentScriptIndex].script_id;
            console.log('Loading research data for script ID:', scriptId);
            
            try {
                updateStatus('loading', 'Loading script data...');
                
                // Load script info and research data
                const [scriptInfo, researchData] = await Promise.all([
                    loadScriptInfo(scriptId),
                    loadResearchData(scriptId)
                ]);
                
                currentScriptData = { script: scriptInfo, research: researchData };
                console.log('Loaded script data:', currentScriptData);
                
                displayScriptData(currentScriptData);
                updateNavigationButtons();
                updateStatus('saved', 'Loaded successfully');
                hasUnsavedChanges = false;
            } catch (error) {
                console.error('Error loading script:', error);
                updateStatus('error', 'Failed to load script data');
            }
        }

        // Load script information
        async function loadScriptInfo(scriptId) {
            console.log('=== DEBUG: Loading script info for script_id:', scriptId);
            const response = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}&select=*`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to load script info:', response.status, errorText);
                throw new Error('Failed to load script info');
            }

            const data = await response.json();
            console.log('Script info loaded:', data[0]);
            return data[0];
        }

        // Load research data
        async function loadResearchData(scriptId) {
            console.log('=== DEBUG: Loading research data for script_id:', scriptId);
            const response = await fetch(`${SUPABASE_URL}/rest/v1/script_research?script_id=eq.${scriptId}&select=*`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to load research data:', response.status, errorText);
                throw new Error('Failed to load research data');
            }

            const data = await response.json();
            console.log('Research data loaded:', data);
            if (data[0] && data[0].script_research_id) {
                console.log('WARNING: Research data has script_research_id:', data[0].script_research_id, '- Make sure we display script_id instead');
            }
            return data[0] || {}; // Return empty object if no research data exists yet
        }

        // Display script data in UI
        function displayScriptData(data) {
            if (!data) return;

            document.getElementById('content').style.display = 'block';
            document.getElementById('noScriptsMessage').style.display = 'none';
            document.getElementById('scriptInfo').style.display = 'grid';

            // Update script info - Make sure we're using script_id, not script_research_id
            document.getElementById('scriptIdValue').textContent = data.script.script_id || '-';
            document.getElementById('wordsValue').textContent = data.script.target_word_count || '-';
            document.getElementById('clientValue').textContent = data.script.client_name || '-';
            document.getElementById('channelValue').textContent = data.script.channel_name || '-';
            document.getElementById('typeValue').textContent = data.script.script_type || '-';
            document.getElementById('genreValue').textContent = data.script.genre || '-';
            document.getElementById('subgenreValue').textContent = data.script.subgenre || '-';
            document.getElementById('formatValue').textContent = data.script.format || '-';
            document.getElementById('structureValue').textContent = data.script.structure || '-';
            document.getElementById('researchValue').textContent = data.script.research_depth || '-';
            document.getElementById('toneValue').textContent = data.script.tone || '-';
            document.getElementById('angleValue').textContent = data.script.angle || '-';
            
            // Display research fields
            displayResearchFields(data.research);
        }

        // Display research fields
        function displayResearchFields(researchData) {
            const container = document.getElementById('researchList');
            container.innerHTML = '';

            RESEARCH_FIELDS.forEach(field => {
                const fieldSection = document.createElement('div');
                fieldSection.className = 'chapter-se-7a2807fb2c0d'; // Reuse existing styling
                
                fieldSection.innerHTML = `
                    <!-- Field Label Button -->
                    <button class="gradient-button">
                        <span class="gradient-button__text">${field.label}</span>
                    </button>
                    
                    <!-- Field Content Row -->
                    <div class="form-row">
                        <div class="form-row__text-field">
                            <div class="text-field-multi">
                                <div class="text-field-multi__container">
                                    <textarea class="text-field-multi__input" 
                                             id="research_${field.name}" 
                                             data-field="${field.name}"
                                             style="min-height: 225px; height: 225px;"
                                             placeholder="Enter ${field.label.toLowerCase()}...">${researchData[field.name] || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-row__rating-field">
                            <div class="rating-field">
                                <label class="rating-field__label">Rating / 100:</label>
                                <div class="rating-field__container">
                                    <input type="number" 
                                           class="rating-field__input" 
                                           id="rating_${field.name}"
                                           data-field="${field.name}_mp_rating"
                                           min="1" 
                                           max="100" 
                                           value="${researchData[field.name + '_mp_rating'] || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(fieldSection);
            });

            // Force textarea heights immediately - bypass auto-resize module issues
            setTimeout(() => {
                console.log('=== DEBUG: Setting textarea heights ===');
                const textareas = document.querySelectorAll('.text-field-multi__input');
                console.log('Found textareas:', textareas.length);
                
                textareas.forEach((textarea, index) => {
                    console.log(`Setting height for textarea ${index}:`, textarea);
                    
                    // Force styles directly
                    textarea.style.minHeight = '225px';
                    textarea.style.height = '225px';
                    textarea.style.overflowY = 'hidden';
                    textarea.style.resize = 'none';
                    textarea.style.boxSizing = 'border-box';
                    
                    if (textarea.value && textarea.value.length > 0) {
                        console.log('Textarea has content, expanding:', textarea.value.length);
                        textarea.style.height = 'auto';
                        const newHeight = Math.max(225, textarea.scrollHeight + 15);
                        textarea.style.height = newHeight + 'px';
                        console.log('Set height to:', newHeight);
                    } else {
                        console.log('Textarea is empty, using minimum height');
                    }
                    
                    // Add input listener for real-time resizing
                    textarea.addEventListener('input', function() {
                        this.style.height = 'auto';
                        const newHeight = Math.max(225, this.scrollHeight + 15);
                        this.style.height = newHeight + 'px';
                        this.style.overflowY = 'hidden';
                    });
                });
            }, 200);
        }

        // Save script function - UPDATED to change status from 12 to 13
        async function saveScript() {
            if (isLoading) return;
            
            try {
                isLoading = true;
                updateStatus('loading', 'Saving research data and updating status...');
                
                const scriptId = scriptsToReview[currentScriptIndex].script_id;
                const researchData = collectResearchData();
                
                // Save research data AND update script status
                await saveResearchDataAndUpdateStatus(scriptId, researchData);
                
                updateStatus('saved', 'Research saved and status updated to 13');
                hasUnsavedChanges = false;
                if (window.setUnsavedChanges) {
                    window.setUnsavedChanges(false);
                }
                
                // Remove this script from the review list since it's now status 13
                scriptsToReview.splice(currentScriptIndex, 1);
                
                // Load next script or show completion message
                if (scriptsToReview.length > 0) {
                    // Adjust index if we're at the end
                    if (currentScriptIndex >= scriptsToReview.length) {
                        currentScriptIndex = 0;
                    }
                    await loadCurrentScriptData();
                } else {
                    updateStatus('completed', 'All research completed!');
                    showNoScriptsMessage();
                }
                
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('error', 'Failed to save research data');
            } finally {
                isLoading = false;
            }
        }

        // Collect research data from form
        function collectResearchData() {
            const data = {};
            
            RESEARCH_FIELDS.forEach(field => {
                const textField = document.getElementById(`research_${field.name}`);
                const ratingField = document.getElementById(`rating_${field.name}`);
                
                if (textField) data[field.name] = textField.value;
                if (ratingField && ratingField.value) data[field.name + '_mp_rating'] = parseInt(ratingField.value);
            });
            
            return data;
        }

        // Save research data to Supabase AND update script status to 13
        async function saveResearchDataAndUpdateStatus(scriptId, data) {
            const dataWithScript = { ...data, script_id: scriptId };
            
            // Save research data first
            let response = await fetch(`${SUPABASE_URL}/rest/v1/script_research?script_id=eq.${scriptId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(dataWithScript)
            });

            if (!response.ok) {
                // If update failed, try insert
                response = await fetch(`${SUPABASE_URL}/rest/v1/script_research`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(dataWithScript)
                });
            }

            if (!response.ok) {
                throw new Error('Failed to save research data');
            }

            // Now update the script status from 12 to 13
            const statusResponse = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ script_status_id: 13 })
            });

            if (!statusResponse.ok) {
                throw new Error('Failed to update script status to 13');
            }

            return await response.json();
        }

        // Save research data to Supabase (for auto-save - no status change)
        async function saveResearchData(scriptId, data) {
            const dataWithScript = { ...data, script_id: scriptId };
            
            // Try to update first, then insert if no record exists
            let response = await fetch(`${SUPABASE_URL}/rest/v1/script_research?script_id=eq.${scriptId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(dataWithScript)
            });

            if (!response.ok) {
                // If update failed, try insert
                response = await fetch(`${SUPABASE_URL}/rest/v1/script_research`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(dataWithScript)
                });
            }

            if (!response.ok) {
                throw new Error('Failed to save research data');
            }

            return await response.json();
        }

        // Navigate between scripts
        async function navigateScript(direction) {
            if (isLoading) return;

            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Do you want to continue without saving?')) {
                    return;
                }
            }

            const newIndex = currentScriptIndex + direction;
            if (newIndex >= 0 && newIndex < scriptsToReview.length) {
                currentScriptIndex = newIndex;
                await loadCurrentScriptData();
            }
        }

        // Update navigation button states
        function updateNavigationButtons() {
            // Update the bottom navigation component
            if (window.updateBottomNavigation) {
                window.updateBottomNavigation(currentScriptIndex, scriptsToReview.length);
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Add change listeners to mark unsaved changes
            RESEARCH_FIELDS.forEach(field => {
                const textField = document.getElementById(`research_${field.name}`);
                const ratingField = document.getElementById(`rating_${field.name}`);
                
                if (textField) {
                    textField.addEventListener('input', () => {
                        hasUnsavedChanges = true;
                        updateStatus('unsaved', 'Unsaved changes');
                        if (window.setUnsavedChanges) {
                            window.setUnsavedChanges(true);
                        }
                    });
                }
                
                if (ratingField) {
                    ratingField.addEventListener('input', () => {
                        hasUnsavedChanges = true;
                        updateStatus('unsaved', 'Unsaved changes');
                        if (window.setUnsavedChanges) {
                            window.setUnsavedChanges(true);
                        }
                    });
                }
            });
        }

        // Auto-save functionality
        function startAutoSave() {
            // Use the bottom navigation component's auto-save
            if (window.bottomNav) {
                window.bottomNav.startAutoSave(async () => {
                    const scriptId = scriptsToReview[currentScriptIndex].script_id;
                    const researchData = collectResearchData();
                    await saveResearchData(scriptId, researchData);
                    hasUnsavedChanges = false;
                });
            }
        }

        // Utility functions
        function updateStatus(status, message) {
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                statusIndicator.textContent = message;
                statusIndicator.className = `status-indicator ${status}`;
            }
        }

        function showNoScriptsMessage() {
            document.getElementById('content').style.display = 'none';
            document.getElementById('noScriptsMessage').style.display = 'block';
            document.getElementById('noScriptsMessage').innerHTML = `
                <div class="message info">
                    <strong>No scripts found</strong><br>
                    There are no scripts ready for research (status_id = 12) at this time.
                </div>
            `;
        }

        function handleInitializationError(error) {
            updateStatus('error', `Failed to load scripts: ${error.message}`);
            
            document.getElementById('noScriptsMessage').innerHTML = `
                <div class="message error">
                    <strong>Error loading scripts:</strong><br>
                    ${error.message}<br><br>
                    <small>Check the browser console (F12) for more details.</small>
                </div>
            `;
            document.getElementById('content').style.display = 'none';
            document.getElementById('noScriptsMessage').style.display = 'block';
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting Research Editor initialization...');
            init().catch(error => {
                console.error('Failed to initialize Research Editor:', error);
            });
        });

        // Make functions available globally for HTML onclick handlers
        window.saveScript = saveScript;
        window.navigateScript = navigateScript;
    </script>
</body>
</html>