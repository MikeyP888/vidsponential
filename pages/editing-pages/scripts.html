<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Script</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
        <link rel="stylesheet" href="../../shared/styles/theme.css">
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">
    
    <style>
        .client-form-section {
            margin: 20px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 11px;
            font-family: "Inter", sans-serif;
            font-weight: 600;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px;
            font-size: 14px;
            font-family: "Tahoma", sans-serif;
            border: 0.5px solid #5b5a5a;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #0099ff;
            box-shadow: 0 0 0 3px rgba(0, 153, 255, 0.2);
        }
        
        .submit-btn {
            background: linear-gradient(to right, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%);
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(11, 230, 255, 0.4);
        }
        
        .client-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .clients-list {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .client-item:hover {
            background: #f0f0f0;
        }
        
        .client-info {
            flex: 1;
        }
        
        .client-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .client-location {
            font-size: 14px;
            color: #666;
        }
        
        .edit-btn {
            padding: 8px 16px;
            background: #0099ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .edit-btn:hover {
            background: #0077cc;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .save-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .save-btn {
            background: linear-gradient(to right, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%);
            color: white;
        }
        
        .cancel-btn {
            background: #f0f0f0;
            color: #666;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 11px;
            font-family: "Inter", sans-serif;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 20px;
            font-family: "Tahoma", sans-serif;
            font-weight: bold;
            background: linear-gradient(to right, rgba(11, 230, 255, 1) 0%, rgba(175, 11, 255, 1) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .word-count {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
    </style>
</head>
<body class="has-sidebar">
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <div class="container with-sidebar">
        <!-- Header Section -->
        <div class="header">
            <!-- Status Indicator -->
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">Ready</div>
            </div>
            
            <!-- Page Title -->
            <h1 class="page-title">Add Script</h1>
        </div>

        <!-- Main Content -->
        <div id="content">
            <div class="client-form-section">
                <!-- Client and YouTube Channel Selection -->
                <div class="form-grid" style="margin-bottom: 30px;">
                    <div class="form-group">
                        <label class="form-label" for="clientSelect">Client</label>
                        <select class="form-select" id="clientSelect" onchange="if(this.value) { loadYouTubeChannels(); }">
                            <option value="">Select a client...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="youtubeChannelSelect">YouTube Channel</label>
                        <select class="form-select" id="youtubeChannelSelect" onchange="updateClientStats(); prefillFromLastScript();">
                            <option value="">Select a YouTube channel...</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="section-title">Script Information</h2>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="scriptTitle">Script Title</label>
                    <input type="text" class="form-input" id="scriptTitle" placeholder="Enter script title" required>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="genreSelect">Genre</label>
                        <select class="form-select" id="genreSelect" onchange="loadSubgenres()">
                            <option value="">Select a genre...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="subgenreSelect">Subgenre</label>
                        <select class="form-select" id="subgenreSelect">
                            <option value="">Select a subgenre...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="targetWordCount">Target Word Count</label>
                        <input type="number" class="form-input" id="targetWordCount" placeholder="Enter target word count">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="primaryKeyword">Primary Keyword</label>
                        <input type="text" class="form-input" id="primaryKeyword" placeholder="Enter primary keyword">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="dueDate">Due Date</label>
                        <input type="date" class="form-input" id="dueDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="openingChapterTypeSelect">Opening Chapter Type</label>
                        <select class="form-select" id="openingChapterTypeSelect">
                            <option value="">Select opening chapter type...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="finalChapterTypeSelect">Final Chapter Type</label>
                        <select class="form-select" id="finalChapterTypeSelect">
                            <option value="">Select final chapter type...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="visualStyleSelect">Visual Suggestion Style</label>
                        <select class="form-select" id="visualStyleSelect">
                            <option value="">Select visual style...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" for="niches">Niches</label>
                    <input type="text" class="form-input" id="niches" placeholder="Enter niches separated by commas (e.g., Technology, Science, Education)">
                </div>

                <div class="form-group">
                    <label class="form-label" for="clientNotes">Client Notes</label>
                    <textarea class="form-textarea" id="clientNotes" placeholder="Important notes about this script..."></textarea>
                </div>

                <div style="display: flex; gap: 20px; align-items: flex-end; margin-top: 20px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label class="form-label" for="scriptStatusSelect">Script Status</label>
                        <select class="form-select" id="scriptStatusSelect">
                            <option value="">Loading statuses...</option>
                        </select>
                    </div>
                    <button class="submit-btn" style="margin-top: 0;" onclick="addScript()">Add Script</button>
                </div>
                
                <!-- Script Stats Preview -->
                <div class="client-stats">
                    <div class="stat-item">
                        <div class="stat-label">Total Scripts</div>
                        <div class="stat-value" id="totalScripts">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Scripts Created This Week</div>
                        <div class="stat-value" id="scriptsWeek">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Scripts Created This Month</div>
                        <div class="stat-value" id="scriptsMonth">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Scripts List -->
            <div class="clients-list">
                <h2 class="section-title">Scripts</h2>
                <div id="scriptsList">
                    <!-- Script items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Script Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 class="section-title">Edit Script</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="editScriptTitle">Script Title</label>
                    <input type="text" class="form-input" id="editScriptTitle">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editGenre">Genre</label>
                    <select class="form-select" id="editGenre" onchange="loadEditSubgenres()">
                        <!-- Options will be populated from database -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editSubgenre">Subgenre</label>
                    <select class="form-select" id="editSubgenre">
                        <!-- Options will be populated from database -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="editTargetWordCount">Target Word Count</label>
                    <input type="number" class="form-input" id="editTargetWordCount">
                </div>

                <div class="form-group">
                    <label class="form-label" for="editPrimaryKeyword">Primary Keyword</label>
                    <input type="text" class="form-input" id="editPrimaryKeyword">
                </div>

                <div class="form-group">
                    <label class="form-label" for="editDueDate">Due Date</label>
                    <input type="date" class="form-input" id="editDueDate">
                </div>

                <div class="form-group">
                    <label class="form-label" for="editOpeningChapterType">Opening Chapter Type</label>
                    <select class="form-select" id="editOpeningChapterType">
                        <!-- Options will be populated from database -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editFinalChapterType">Final Chapter Type</label>
                    <select class="form-select" id="editFinalChapterType">
                        <!-- Options will be populated from database -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editVisualStyle">Visual Suggestion Style</label>
                    <select class="form-select" id="editVisualStyle">
                        <!-- Options will be populated from database -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editScriptStatus">Script Status</label>
                    <select class="form-select" id="editScriptStatus">
                        <!-- Options will be populated from database -->
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="editNiches">Niches</label>
                <input type="text" class="form-input" id="editNiches" placeholder="Enter niches separated by commas">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="editNotes">Client Notes</label>
                <textarea class="form-textarea" id="editNotes"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="save-btn" onclick="saveScriptChanges()">Save Changes</button>
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

        <script src="../../shared/js/theme-manager.js"></script>
    <script type="module" src="../../shared/js/sidebar-component.js"></script>
    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../../shared/js/config.js';
        import { getWeekStart } from '../../shared/js/editor-utils.js';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentEditingScriptId = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing scripts.html...');
            loadClients();
            loadGenres();
            loadScriptStatuses();
            loadOpeningChapterTypes();
            loadFinalChapterTypes();
            loadVisualStyles();
            setDefaultDueDate();
        });

        // Set default due date to 2 days from today
        function setDefaultDueDate() {
            const today = new Date();
            today.setDate(today.getDate() + 2);
            const dueDateStr = today.toISOString().split('T')[0];
            document.getElementById('dueDate').value = dueDateStr;
        }
        
        // Load clients dropdown
        async function loadClients() {
            console.log('Loading clients...');
            try {
                const { data: clients, error } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('client_status_id', 1)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Clients loaded:', clients);
                
                const clientSelect = document.getElementById('clientSelect');
                clientSelect.innerHTML = '<option value="">Select a client...</option>';
                
                if (clients) {
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = `${client.client_first_name} ${client.client_last_name}`;
                        clientSelect.appendChild(option);
                    });
                    console.log('Client options added to dropdown');
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                console.log('Falling back to placeholder clients...');
                setupPlaceholderClients();
            }
        }
        
        // Setup placeholder clients if database fails
        function setupPlaceholderClients() {
            console.log('Setting up placeholder clients...');
            
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = `
                <option value="">Select a client...</option>
                <option value="1">John Smith</option>
                <option value="2">Sarah Johnson</option>
                <option value="3">Mike Davis</option>
                <option value="4">Lisa Wilson</option>
                <option value="5">Tom Anderson</option>
            `;
            
            console.log('Placeholder clients set up');
        }
        
        
        // Load YouTube channels for selected client
        async function loadYouTubeChannels() {
            const clientId = document.getElementById('clientSelect').value;
            const channelSelect = document.getElementById('youtubeChannelSelect');
            
            // Clear and reset the dropdown first
            channelSelect.innerHTML = '<option value="">Select a YouTube channel...</option>';
            
            // Validate clientId
            if (!clientId || clientId === '' || clientId === 'undefined') {
                console.log('No client selected, YouTube channels dropdown reset');
                return;
            }
            
            // Ensure clientId is a valid number
            const clientIdNum = parseInt(clientId);
            if (isNaN(clientIdNum)) {
                console.error('Invalid client ID:', clientId);
                channelSelect.innerHTML = '<option value="">Invalid client selected</option>';
                return;
            }
            
            console.log('Loading YouTube channels for client ID:', clientIdNum);
            
            try {
                const { data: channels, error } = await supabase
                    .from('youtube_channels')
                    .select('*')
                    .eq('client_id', clientIdNum)
                    .order('youtube_channel_name');
                
                if (error) throw error;
                
                console.log('YouTube channels loaded:', channels);
                
                channelSelect.innerHTML = '<option value="">Select a YouTube channel...</option>';
                
                if (channels && channels.length > 0) {
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.youtube_channel_id;
                        option.textContent = channel.youtube_channel_name;
                        channelSelect.appendChild(option);
                    });
                    console.log(`${channels.length} YouTube channel options added to dropdown`);

                    // Auto-select the YouTube channel from the last script for this client
                    try {
                        const { data: lastScript, error: scriptError } = await supabase
                            .from('scripts')
                            .select('youtube_channel_id')
                            .eq('client_id', clientIdNum)
                            .order('created_at', { ascending: false })
                            .limit(1)
                            .single();

                        if (!scriptError && lastScript && lastScript.youtube_channel_id) {
                            console.log('Auto-selecting YouTube channel from last script:', lastScript.youtube_channel_id);
                            channelSelect.value = lastScript.youtube_channel_id;
                            // Trigger the update and prefill functions
                            updateClientStats();
                            prefillFromLastScript();
                        }
                    } catch (error) {
                        console.log('No previous script found for auto-selecting channel');
                    }
                } else {
                    console.log('No YouTube channels found for client ID:', clientIdNum);
                    channelSelect.innerHTML = '<option value="">No channels for this client</option>';
                }
            } catch (error) {
                console.error('Error loading YouTube channels:', error);
                console.log('Database error details:', error.message);
                channelSelect.innerHTML = '<option value="">Error loading channels</option>';
            }
        }
        
        // Setup placeholder genres if database fails
        function setupPlaceholderGenres() {
            const genreSelect = document.getElementById('genreSelect');
            const editGenreSelect = document.getElementById('editGenre');
            
            // Temporarily remove onchange handler to prevent it from firing during population
            const originalOnChange = genreSelect.onchange;
            genreSelect.onchange = null;
            
            const genreOptions = `
                <option value="">Select a genre...</option>
                <option value="1">Educational</option>
                <option value="2">Entertainment</option>
                <option value="3">Technology</option>
                <option value="4">Health</option>
                <option value="5">Finance</option>
            `;
            
            genreSelect.innerHTML = genreOptions;
            editGenreSelect.innerHTML = genreOptions;
            
            // Restore the onchange handler
            genreSelect.onchange = originalOnChange;
        }
        
        // Load genres
        async function loadGenres() {
            console.log('Loading genres...');
            try {
                const { data: genres, error } = await supabase
                    .from('genres')
                    .select('*')
                    .order('genre');
                
                if (error) throw error;
                
                console.log('Genres loaded:', genres);
                
                const genreSelect = document.getElementById('genreSelect');
                const editGenreSelect = document.getElementById('editGenre');
                
                // Temporarily remove onchange handler to prevent it from firing during population
                const originalOnChange = genreSelect.onchange;
                genreSelect.onchange = null;
                
                genreSelect.innerHTML = '<option value="">Select a genre...</option>';
                editGenreSelect.innerHTML = '<option value="">Select a genre...</option>';
                
                if (genres && genres.length > 0) {
                    genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre.genre_id;
                        option.textContent = genre.genre;
                        genreSelect.appendChild(option.cloneNode(true));
                        editGenreSelect.appendChild(option);
                    });
                    console.log('Genre options added to dropdowns');
                } else {
                    console.log('No genres found, setting up placeholder...');
                    setupPlaceholderGenres();
                }
                
                // Restore the onchange handler
                genreSelect.onchange = originalOnChange;
            } catch (error) {
                console.error('Error loading genres:', error);
                console.log('Falling back to placeholder genres...');
                setupPlaceholderGenres();
            }
        }
        
        // Load subgenres based on selected genre
        async function loadSubgenres() {
            console.log('loadSubgenres function called');
            console.log('Call stack:', new Error().stack);
            const genreSelect = document.getElementById('genreSelect');
            const genreId = genreSelect ? genreSelect.value : null;
            const subgenreSelect = document.getElementById('subgenreSelect');
            
            console.log('Selected genre ID:', genreId);
            console.log('Subgenre select element:', subgenreSelect);
            
            if (!genreId || genreId === '' || genreId === 'undefined') {
                subgenreSelect.innerHTML = '<option value="">Select a subgenre...</option>';
                console.log('No valid genre selected, showing default option');
                return;
            }
            
            console.log('Loading subgenres for genre:', genreId);
            
            try {
                const { data: subgenres, error } = await supabase
                    .from('subgenres')
                    .select('*')
                    .eq('genre_id', parseInt(genreId))
                    .order('subgenre');
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Subgenres loaded:', subgenres);
                console.log('Number of subgenres found:', subgenres ? subgenres.length : 0);
                
                subgenreSelect.innerHTML = '<option value="">Select a subgenre...</option>';
                
                if (subgenres && subgenres.length > 0) {
                    subgenres.forEach(subgenre => {
                        console.log('Adding subgenre:', subgenre.subgenre, 'with ID:', subgenre.subgenre_id);
                        const option = document.createElement('option');
                        option.value = subgenre.subgenre_id;
                        option.textContent = subgenre.subgenre;
                        subgenreSelect.appendChild(option);
                    });
                    console.log('Subgenre options added to dropdown');
                    console.log('Final dropdown HTML:', subgenreSelect.innerHTML);
                } else {
                    console.log('No subgenres found for genre:', genreId);
                }
            } catch (error) {
                console.error('Error loading subgenres:', error);
                console.error('Error details:', error.message);
            }
        }
        
        // Load subgenres for edit modal
        async function loadEditSubgenres() {
            const genreId = document.getElementById('editGenre').value;
            const subgenreSelect = document.getElementById('editSubgenre');
            
            if (!genreId) {
                subgenreSelect.innerHTML = '<option value="">Select a subgenre...</option>';
                return;
            }
            
            try {
                const { data: subgenres, error } = await supabase
                    .from('subgenres')
                    .select('*')
                    .eq('genre_id', genreId)
                    .order('subgenre');
                
                if (error) throw error;
                
                const currentValue = subgenreSelect.value;
                subgenreSelect.innerHTML = '<option value="">Select a subgenre...</option>';
                
                if (subgenres && subgenres.length > 0) {
                    subgenres.forEach(subgenre => {
                        const option = document.createElement('option');
                        option.value = subgenre.subgenre_id;
                        option.textContent = subgenre.subgenre;
                        subgenreSelect.appendChild(option);
                    });
                    
                    // Restore previous selection if it's still valid
                    if (currentValue && Array.from(subgenreSelect.options).some(opt => opt.value === currentValue)) {
                        subgenreSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading edit subgenres:', error);
            }
        }
        
        // Pre-fill form fields based on the most recent script
        async function prefillFromLastScript() {
            const clientId = document.getElementById('clientSelect').value;
            const youtubeChannelId = document.getElementById('youtubeChannelSelect').value;

            // Build query based on what's selected
            let query = supabase
                .from('scripts')
                .select('*');

            // YouTube channel takes precedence if selected
            if (youtubeChannelId && youtubeChannelId !== '') {
                query = query.eq('youtube_channel_id', parseInt(youtubeChannelId));
            } else if (clientId && clientId !== '') {
                query = query.eq('client_id', parseInt(clientId));
            } else {
                // No client or channel selected, don't prefill
                return;
            }

            // Get the most recent script
            query = query.order('created_at', { ascending: false }).limit(1);

            try {
                const { data: scripts, error } = await query;

                if (error) throw error;

                if (scripts && scripts.length > 0) {
                    const lastScript = scripts[0];
                    console.log('Pre-filling from last script:', lastScript);

                    // Pre-fill genre
                    if (lastScript.genre_id) {
                        document.getElementById('genreSelect').value = lastScript.genre_id;
                        // Load subgenres for this genre
                        await loadSubgenres();

                        // Pre-fill subgenre after loading
                        if (lastScript.subgenre_id) {
                            document.getElementById('subgenreSelect').value = lastScript.subgenre_id;
                        }
                    }

                    // Pre-fill target word count
                    if (lastScript.target_word_count) {
                        document.getElementById('targetWordCount').value = lastScript.target_word_count;
                    }

                    // Pre-fill opening chapter type
                    if (lastScript.opening_chapter_type_id) {
                        document.getElementById('openingChapterTypeSelect').value = lastScript.opening_chapter_type_id;
                    }

                    // Pre-fill final chapter type
                    if (lastScript.final_chapter_type_id) {
                        document.getElementById('finalChapterTypeSelect').value = lastScript.final_chapter_type_id;
                    }

                    // Pre-fill visual suggestion style
                    if (lastScript.visual_suggestion_style_id) {
                        document.getElementById('visualStyleSelect').value = lastScript.visual_suggestion_style_id;
                    }

                    console.log('Form pre-filled successfully');
                } else {
                    console.log('No previous scripts found for pre-filling');
                }
            } catch (error) {
                console.error('Error pre-filling from last script:', error);
            }
        }

        // Load opening chapter types
        async function loadOpeningChapterTypes() {
            try {
                const { data, error } = await supabase
                    .from('opening_chapter_types')
                    .select('*')
                    .order('opening_chapter_type_id');

                if (error) throw error;

                const select = document.getElementById('openingChapterTypeSelect');
                const editSelect = document.getElementById('editOpeningChapterType');

                if (data && data.length > 0) {
                    data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.opening_chapter_type_id;
                        option.textContent = type.opening_chapter_type;
                        select.appendChild(option.cloneNode(true));
                        editSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading opening chapter types:', error);
            }
        }

        // Load final chapter types
        async function loadFinalChapterTypes() {
            try {
                const { data, error } = await supabase
                    .from('final_chapter_types')
                    .select('*')
                    .order('final_chapter_type_id');

                if (error) throw error;

                const select = document.getElementById('finalChapterTypeSelect');
                const editSelect = document.getElementById('editFinalChapterType');

                if (data && data.length > 0) {
                    data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.final_chapter_type_id;
                        option.textContent = type.final_chapter_type;
                        select.appendChild(option.cloneNode(true));
                        editSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading final chapter types:', error);
            }
        }

        // Load visual suggestion styles
        async function loadVisualStyles() {
            try {
                const { data, error } = await supabase
                    .from('visual_suggestion_styles')
                    .select('*')
                    .order('visual_suggestion_style_id');

                if (error) throw error;

                const select = document.getElementById('visualStyleSelect');
                const editSelect = document.getElementById('editVisualStyle');

                if (data && data.length > 0) {
                    data.forEach(style => {
                        const option = document.createElement('option');
                        option.value = style.visual_suggestion_style_id;
                        option.textContent = style.visual_suggestion_style;
                        select.appendChild(option.cloneNode(true));
                        editSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading visual suggestion styles:', error);
            }
        }

        // Load script statuses
        async function loadScriptStatuses() {
            console.log('Loading script statuses...');
            try {
                const { data: statuses, error } = await supabase
                    .from('script_statuses')
                    .select('*')
                    .order('script_status_id');

                if (error) {
                    console.log('Script statuses table error:', error.message);
                    throw error;
                }

                console.log('Script statuses loaded:', statuses);

                const editStatusSelect = document.getElementById('editScriptStatus');
                const addStatusSelect = document.getElementById('scriptStatusSelect');

                if (!editStatusSelect || !addStatusSelect) {
                    console.log('Status select elements not found');
                    return;
                }

                editStatusSelect.innerHTML = '';
                addStatusSelect.innerHTML = '';

                if (statuses && statuses.length > 0) {
                    statuses.forEach(status => {
                        // For edit modal
                        const editOption = document.createElement('option');
                        editOption.value = status.script_status_id;
                        editOption.textContent = status.script_status;
                        editStatusSelect.appendChild(editOption);

                        // For add form
                        const addOption = document.createElement('option');
                        addOption.value = status.script_status_id;
                        addOption.textContent = `${status.script_status_id} - ${status.script_status}`;
                        addStatusSelect.appendChild(addOption);
                    });

                    // Set default to 10
                    addStatusSelect.value = 10;

                    console.log('Script status options added to dropdowns');
                } else {
                    console.log('No script statuses found, setting up placeholder...');
                    setupPlaceholderStatuses();
                }
            } catch (error) {
                console.error('Error loading script statuses:', error.message || error);
                console.log('Falling back to placeholder statuses...');
                setupPlaceholderStatuses();
            }
        }
        
        // Setup placeholder statuses if database fails
        function setupPlaceholderStatuses() {
            const editStatusSelect = document.getElementById('editScriptStatus');
            const addStatusSelect = document.getElementById('scriptStatusSelect');

            editStatusSelect.innerHTML = `
                <option value="1">Draft</option>
                <option value="2">In Review</option>
                <option value="3">Approved</option>
                <option value="4">Published</option>
                <option value="10">New</option>
            `;

            addStatusSelect.innerHTML = `
                <option value="1">1 - Draft</option>
                <option value="2">2 - In Review</option>
                <option value="3">3 - Approved</option>
                <option value="4">4 - Published</option>
                <option value="10" selected>10 - New</option>
            `;
        }
        
        // Update client statistics
        async function updateClientStats() {
            const clientId = document.getElementById('clientSelect').value;
            const youtubeChannelId = document.getElementById('youtubeChannelSelect').value;
            
            if (!clientId || clientId === '' || clientId === 'undefined') {
                document.getElementById('totalScripts').textContent = '0';
                document.getElementById('scriptsWeek').textContent = '0';
                document.getElementById('scriptsMonth').textContent = '0';
                document.getElementById('scriptsList').innerHTML = '<p style="text-align: center; color: #999;">Select a client to view scripts</p>';
                return;
            }
            
            // Validate clientId is a number
            const clientIdNum = parseInt(clientId);
            if (isNaN(clientIdNum)) {
                console.error('Invalid client ID for stats:', clientId);
                return;
            }
            
            // Validate youtubeChannelId if provided
            let youtubeChannelIdNum = null;
            if (youtubeChannelId && youtubeChannelId !== '') {
                youtubeChannelIdNum = parseInt(youtubeChannelId);
                if (isNaN(youtubeChannelIdNum)) {
                    console.error('Invalid YouTube channel ID:', youtubeChannelId);
                    youtubeChannelIdNum = null;
                }
            }
            
            try {
                // Build query for total scripts
                let totalQuery = supabase
                    .from('scripts')
                    .select('*', { count: 'exact', head: true })
                    .eq('client_id', clientIdNum);
                
                if (youtubeChannelIdNum) {
                    totalQuery = totalQuery.eq('youtube_channel_id', youtubeChannelIdNum);
                }
                
                const { count: totalCount } = await totalQuery;
                document.getElementById('totalScripts').textContent = totalCount || 0;
                
                // Scripts created this week
                const weekStart = getWeekStart();
                let weekQuery = supabase
                    .from('scripts')
                    .select('*', { count: 'exact', head: true })
                    .eq('client_id', clientIdNum)
                    .gte('created_at', weekStart.toISOString());
                
                if (youtubeChannelIdNum) {
                    weekQuery = weekQuery.eq('youtube_channel_id', youtubeChannelIdNum);
                }
                
                const { count: weekCount } = await weekQuery;
                document.getElementById('scriptsWeek').textContent = weekCount || 0;
                
                // Scripts created this month
                const monthStart = new Date();
                monthStart.setDate(1);
                monthStart.setHours(0, 0, 0, 0);
                
                let monthQuery = supabase
                    .from('scripts')
                    .select('*', { count: 'exact', head: true })
                    .eq('client_id', clientIdNum)
                    .gte('created_at', monthStart.toISOString());
                
                if (youtubeChannelIdNum) {
                    monthQuery = monthQuery.eq('youtube_channel_id', youtubeChannelIdNum);
                }
                
                const { count: monthCount } = await monthQuery;
                document.getElementById('scriptsMonth').textContent = monthCount || 0;
                
                // Load scripts for this client (and optionally youtube channel)
                loadScripts(clientIdNum, youtubeChannelIdNum);
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Load scripts for selected client
        async function loadScripts(clientId, youtubeChannelId) {
            if (!clientId || clientId === 'undefined') {
                console.log('No valid client ID provided to loadScripts');
                return;
            }
            
            // Ensure clientId is a number
            const clientIdNum = typeof clientId === 'number' ? clientId : parseInt(clientId);
            if (isNaN(clientIdNum)) {
                console.error('Invalid client ID in loadScripts:', clientId);
                return;
            }
            
            try {
                // Build query
                let query = supabase
                    .from('scripts')
                    .select('*')
                    .eq('client_id', clientIdNum);
                
                // Add YouTube channel filter if provided
                if (youtubeChannelId) {
                    const channelIdNum = typeof youtubeChannelId === 'number' ? youtubeChannelId : parseInt(youtubeChannelId);
                    if (!isNaN(channelIdNum)) {
                        query = query.eq('youtube_channel_id', channelIdNum);
                    }
                }
                
                query = query.order('created_at', { ascending: false });
                
                const { data: scripts, error } = await query;
                
                if (error) throw error;
                
                const scriptsList = document.getElementById('scriptsList');
                scriptsList.innerHTML = '';
                
                if (scripts && scripts.length > 0) {
                    scripts.forEach(script => {
                        const scriptItem = document.createElement('div');
                        scriptItem.className = 'client-item';
                        scriptItem.innerHTML = `
                            <div class="client-info">
                                <div class="client-name">${script.script_headline || 'Untitled Script'}</div>
                                <div class="word-count">Script ID: ${script.script_id} | No of Words: ${script.actual_word_count || 'N/A'}</div>
                            </div>
                            <button class="edit-btn" onclick="editScript(${script.script_id})">Edit</button>
                        `;
                        scriptsList.appendChild(scriptItem);
                    });
                } else {
                    scriptsList.innerHTML = '<p style="text-align: center; color: #999;">No scripts for this client yet</p>';
                }
                
            } catch (error) {
                console.error('Error loading scripts:', error);
            }
        }
        
        // Add new script
        async function addScript() {
            const clientId = document.getElementById('clientSelect').value;
            const youtubeChannelId = document.getElementById('youtubeChannelSelect').value;
            const scriptTitle = document.getElementById('scriptTitle').value.trim();
            const genreId = document.getElementById('genreSelect').value;
            const subgenreId = document.getElementById('subgenreSelect').value;
            const targetWordCount = document.getElementById('targetWordCount').value;
            const primaryKeyword = document.getElementById('primaryKeyword').value.trim();
            const dueDate = document.getElementById('dueDate').value;
            const openingChapterTypeId = document.getElementById('openingChapterTypeSelect').value;
            const finalChapterTypeId = document.getElementById('finalChapterTypeSelect').value;
            const visualStyleId = document.getElementById('visualStyleSelect').value;
            const scriptStatusId = document.getElementById('scriptStatusSelect').value;
            const nichesInput = document.getElementById('niches').value.trim();
            const notes = document.getElementById('clientNotes').value.trim();

            // Parse niches from comma-separated string to array
            const niches = nichesInput ? nichesInput.split(',').map(n => n.trim()).filter(n => n) : null;

            if (!scriptTitle) {
                alert('Please enter a script title');
                return;
            }

            try {
                document.getElementById('statusIndicator').textContent = 'Saving...';

                // Build the insert object, only including fields that have values
                const insertData = {
                    script_headline: scriptTitle,
                    script_status_id: scriptStatusId ? parseInt(scriptStatusId) : 10
                };

                // Only add fields if they have values
                if (clientId) insertData.client_id = parseInt(clientId);
                if (youtubeChannelId) insertData.youtube_channel_id = parseInt(youtubeChannelId);
                if (genreId) insertData.genre_id = parseInt(genreId);
                if (subgenreId) insertData.subgenre_id = parseInt(subgenreId);
                if (targetWordCount) insertData.target_word_count = parseInt(targetWordCount);
                if (primaryKeyword) insertData.primary_keyword = primaryKeyword;
                if (dueDate) insertData.due_date = dueDate;
                if (openingChapterTypeId) insertData.opening_chapter_type_id = parseInt(openingChapterTypeId);
                if (finalChapterTypeId) insertData.final_chapter_type_id = parseInt(finalChapterTypeId);
                if (visualStyleId) insertData.visual_suggestion_style_id = parseInt(visualStyleId);
                if (niches && niches.length > 0) insertData.niches = niches;
                if (notes) insertData.client_notes = notes;

                console.log('Inserting script with data:', insertData);

                const { data, error } = await supabase
                    .from('scripts')
                    .insert([insertData]);

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw error;
                }

                // Clear form
                document.getElementById('clientSelect').value = '';
                document.getElementById('youtubeChannelSelect').innerHTML = '<option value="">Select a YouTube channel...</option>';
                document.getElementById('scriptTitle').value = '';
                document.getElementById('genreSelect').value = '';
                document.getElementById('subgenreSelect').value = '';
                document.getElementById('targetWordCount').value = '';
                document.getElementById('primaryKeyword').value = '';
                setDefaultDueDate(); // Reset to 2 days from today
                document.getElementById('openingChapterTypeSelect').value = '';
                document.getElementById('finalChapterTypeSelect').value = '';
                document.getElementById('visualStyleSelect').value = '';
                document.getElementById('scriptStatusSelect').value = 10; // Reset to default status
                document.getElementById('niches').value = '';
                document.getElementById('clientNotes').value = '';

                // Reset stats display
                document.getElementById('totalScripts').textContent = '0';
                document.getElementById('scriptsWeek').textContent = '0';
                document.getElementById('scriptsMonth').textContent = '0';
                document.getElementById('scriptsList').innerHTML = '<p style="text-align: center; color: #999;">Select a client to view scripts</p>';
                
                // Update status
                document.getElementById('statusIndicator').textContent = 'Script added successfully!';
                setTimeout(() => {
                    document.getElementById('statusIndicator').textContent = 'Ready';
                }, 2000);
                
                // Reload statistics and scripts list
                updateClientStats();
                
            } catch (error) {
                console.error('Error adding script:', error);
                alert('Error adding script: ' + error.message);
                document.getElementById('statusIndicator').textContent = 'Error adding script';
                setTimeout(() => {
                    document.getElementById('statusIndicator').textContent = 'Ready';
                }, 3000);
            }
        }
        
        // Edit script
        async function editScript(scriptId) {
            try {
                const { data: script, error } = await supabase
                    .from('scripts')
                    .select('*')
                    .eq('script_id', scriptId)
                    .single();
                
                if (error) throw error;
                
                if (script) {
                    currentEditingScriptId = scriptId;

                    // Populate modal fields
                    document.getElementById('editScriptTitle').value = script.script_headline || '';
                    document.getElementById('editGenre').value = script.genre_id || '';

                    // Load subgenres for the selected genre
                    if (script.genre_id) {
                        await loadEditSubgenres();
                        document.getElementById('editSubgenre').value = script.subgenre_id || '';
                    }

                    document.getElementById('editTargetWordCount').value = script.target_word_count || '';
                    document.getElementById('editPrimaryKeyword').value = script.primary_keyword || '';
                    document.getElementById('editDueDate').value = script.due_date || '';
                    document.getElementById('editOpeningChapterType').value = script.opening_chapter_type_id || '';
                    document.getElementById('editFinalChapterType').value = script.final_chapter_type_id || '';
                    document.getElementById('editVisualStyle').value = script.visual_suggestion_style_id || '';

                    // Convert niches array to comma-separated string
                    if (script.niches && Array.isArray(script.niches)) {
                        document.getElementById('editNiches').value = script.niches.join(', ');
                    } else {
                        document.getElementById('editNiches').value = '';
                    }

                    document.getElementById('editScriptStatus').value = script.script_status_id || 10;
                    document.getElementById('editNotes').value = script.client_notes || '';

                    // Show modal
                    document.getElementById('editModal').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading script:', error);
            }
        }
        
        // Save script changes
        async function saveScriptChanges() {
            if (!currentEditingScriptId) return;

            try {
                // Parse niches from comma-separated string to array
                const nichesInput = document.getElementById('editNiches').value.trim();
                const niches = nichesInput ? nichesInput.split(',').map(n => n.trim()).filter(n => n) : null;

                const { error } = await supabase
                    .from('scripts')
                    .update({
                        script_headline: document.getElementById('editScriptTitle').value.trim(),
                        genre_id: document.getElementById('editGenre').value || null,
                        subgenre_id: document.getElementById('editSubgenre').value || null,
                        target_word_count: document.getElementById('editTargetWordCount').value || null,
                        primary_keyword: document.getElementById('editPrimaryKeyword').value.trim(),
                        due_date: document.getElementById('editDueDate').value || null,
                        opening_chapter_type_id: document.getElementById('editOpeningChapterType').value || null,
                        final_chapter_type_id: document.getElementById('editFinalChapterType').value || null,
                        visual_suggestion_style_id: document.getElementById('editVisualStyle').value || null,
                        niches: niches,
                        script_status_id: parseInt(document.getElementById('editScriptStatus').value),
                        client_notes: document.getElementById('editNotes').value.trim()
                    })
                    .eq('script_id', currentEditingScriptId);

                if (error) throw error;

                closeModal();
                updateClientStats();

                document.getElementById('statusIndicator').textContent = 'Script updated successfully!';
                setTimeout(() => {
                    document.getElementById('statusIndicator').textContent = 'Ready';
                }, 2000);

            } catch (error) {
                console.error('Error updating script:', error);
                alert('Error updating script. Please try again.');
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingScriptId = null;
        }
        
        
        // Make functions available globally for HTML onclick handlers
        window.addScript = addScript;
        window.editScript = editScript;
        window.saveScriptChanges = saveScriptChanges;
        window.closeModal = closeModal;
        window.loadYouTubeChannels = loadYouTubeChannels;
        window.updateClientStats = updateClientStats;
        window.loadSubgenres = loadSubgenres;
        window.loadEditSubgenres = loadEditSubgenres;
        window.prefillFromLastScript = prefillFromLastScript;
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>