<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Editor</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçé</text></svg>">
    
    <link rel="stylesheet" href="../../shared/styles/fonts.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/base.css">
    <link rel="stylesheet" href="../../shared/styles/layout.css">
    <link rel="stylesheet" href="../../shared/styles/buttons.css">
    <link rel="stylesheet" href="../../shared/styles/forms.css">
    <link rel="stylesheet" href="../../shared/styles/status.css">
    <link rel="stylesheet" href="../../shared/styles/notifications.css">
    <link rel="stylesheet" href="../../shared/styles/script_editor_styles.css">
    <link rel="stylesheet" href="../../shared/styles/missing-layout.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/sidebar.css">
    <link rel="stylesheet" href="../../shared/styles/bottom-navigation.css">
</head>
<body class="has-sidebar">
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>
    
    <div class="container with-sidebar">
        <!-- =============================================== -->
        <!--                 HEADER SECTION                -->
        <!-- =============================================== -->
        <div class="header">
            
            <!-- Second horizontal container: Status Indicator -->
            <div class="status-bar">
                <div class="status-indicator" id="statusIndicator">Loading</div>
            </div>
            
            <!-- Third horizontal container: Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Script Chapters Completed Today: <span id="chaptersCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Fourth horizontal container: Overall Scripts Completed Today -->
            <div class="completed-today-bar">
                <div class="completed-today-text">Scripts Completed Today: <span id="scriptsCompletedTodayCount">0</span></div>
            </div>
            
            <!-- Page Title -->
            <h1 class="page-title">Chapter Editor</h1>
        </div>

        <!-- =============================================== -->
        <!--                 MAIN CONTENT                  -->
        <!-- =============================================== -->
        <div id="content">
            <!-- Script Info Section -->
            <div class="info-section">
                <div class="script-info" id="scriptInfo" style="display: none;">
                    <div class="info-item">
                        <div class="info-label">Script ID</div>
                        <div class="info-value" id="scriptIdValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Words</div>
                        <div class="info-value" id="wordsValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Client</div>
                        <div class="info-value" id="clientValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Channel</div>
                        <div class="info-value" id="channelValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Type</div>
                        <div class="info-value" id="typeValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Genre</div>
                        <div class="info-value" id="genreValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Subgenre</div>
                        <div class="info-value" id="subgenreValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Format</div>
                        <div class="info-value" id="formatValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Structure</div>
                        <div class="info-value" id="structureValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Research Depth</div>
                        <div class="info-value" id="researchValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tone</div>
                        <div class="info-value" id="toneValue">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Angle</div>
                        <div class="info-value" id="angleValue">-</div>
                    </div>
                </div>
            </div>
            <!-- Working Headline and Primary Keyword Fields -->
            <div class="main-fields">
                <!-- Working Headline Section -->
                <div class="headline-options">
                    <h2 class="section-title">Headline</h2>
                    <div class="chapter-se-7a2807fb2c0d">
                        <!-- Working Headline Row -->
                        <div class="ch-title-7a2807fb2c0f">
                            <!-- Headline Text + Label -->
                            <div class="title-la-7a2807fb2c1a">
                                <label class="label-ch-7a2807fb2c1f">Headline:</label>
                                <div class="title-fiel-7a2807fb2c1e">
                                    <textarea class="chapter-ti-7a2807fb2c20" id="workingHeadline" placeholder="Enter the working headline..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Headline Rating + Label -->
                            <div class="title-rating-l-7a2807fb2c19">
                                <label class="label-rat-7a2807fb2c1c">Rating / 100:</label>
                                <div class="rating-fie-7a2807fb2c1b">
                                    <input type="number" class="rating-7a2807fb2c1d" id="workingHeadlineRating" data-field="script_headline_mp_rating" min="1" max="100" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Primary Keyword Section -->
                <div class="headline-options">
                    <h2 class="section-title">Primary Keyword</h2>
                    <div class="chapter-se-7a2807fb2c0d">
                        <!-- Primary Keyword Row -->
                        <div class="ch-title-7a2807fb2c0f">
                            <!-- Keyword Text + Label -->
                            <div class="title-la-7a2807fb2c1a">
                                <label class="label-ch-7a2807fb2c1f">Primary Keyword:</label>
                                <div class="title-fiel-7a2807fb2c1e">
                                    <input type="text" class="chapter-ti-7a2807fb2c20" id="primaryKeyword" placeholder="Enter the primary keyword...">
                                </div>
                            </div>
                            
                            <!-- Keyword Rating + Label -->
                            <div class="title-rating-l-7a2807fb2c19">
                                <label class="label-rat-7a2807fb2c1c">Rating / 100:</label>
                                <div class="rating-fie-7a2807fb2c1b">
                                    <input type="number" class="rating-7a2807fb2c1d" id="primaryKeywordRating" data-field="primary_keyword_mp_rating" min="1" max="100" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Chapter Outlines Section -->
            <div class="chapters-section">
                <h2 class="section-title">Chapters</h2>
                <div id="chaptersList"></div>
            </div>
        </div>

        <!-- =============================================== -->
        <!--                 NO SCRIPTS MESSAGE            -->
        <!-- =============================================== -->
        <div id="noScriptsMessage" class="message" style="display: none;">
            No script outlines to display - everything checked ‚úì
        </div>

        <!-- Bottom navigation will be added by JavaScript -->
    </div>

    <script type="module" src="../../shared/js/sidebar-component.js"></script>
    <script type="module" src="../../shared/js/textarea-autosize.js"></script>
    <script>
        // Chapter Editor Application - Loads scripts with status_id=25, updates to 35
        
        const SUPABASE_URL = 'https://euzbpslzrimyokzvgbzk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1emJwc2x6cmlteW9renZnYnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NDk5MTUsImV4cCI6MjA2NjEyNTkxNX0.HBznM8FVX0VnYBN8rTu6T-QOPmq0d60syavTCADl3JI';
        
        let scriptsToReview = [];
        let currentScriptIndex = 0;
        let hasUnsavedChanges = false;
        let isLoading = false;

        // Chapter fields configuration
        const CHAPTER_FIELDS = [
            { name: 'chapter_1', label: 'CHAPTER 1' },
            { name: 'chapter_2', label: 'CHAPTER 2' },
            { name: 'chapter_3', label: 'CHAPTER 3' },
            { name: 'chapter_4', label: 'CHAPTER 4' },
            { name: 'chapter_5', label: 'CHAPTER 5' },
            { name: 'chapter_6', label: 'CHAPTER 6' },
            { name: 'chapter_7', label: 'CHAPTER 7' },
            { name: 'chapter_8', label: 'CHAPTER 8' }
        ];

        async function init() {
            try {
                console.log('=== CHAPTER EDITOR DEBUG: Starting initialization ===');
                updateStatus('loading', 'Loading scripts...');
                
                const scripts = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_status_id=eq.25&select=script_id,script_headline`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                }).then(r => r.json());
                
                console.log('Loaded chapter scripts:', scripts);
                scriptsToReview = scripts;
                
                if (scripts.length > 0) {
                    await loadCurrentScriptData();
                    setupEventListeners();
                    startAutoSave();
                } else {
                    showNoScriptsMessage('There are no scripts ready for chapters (status_id = 25) at this time.');
                }
            } catch (error) {
                console.error('Chapter Editor initialization error:', error);
                updateStatus('error', `Failed to load scripts: ${error.message}`);
            }
        }

        async function loadCurrentScriptData() {
            if (scriptsToReview.length === 0) return;
            
            const scriptId = scriptsToReview[currentScriptIndex].script_id;
            
            try {
                const scriptInfo = await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}&select=*`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                }).then(r => r.json()).then(data => data[0]);
                
                const chapterData = await loadChapterData(scriptId);
                
                displayScriptData({ script: scriptInfo, chapters: chapterData });
                updateNavigationButtons();
                updateStatus('saved', 'Loaded successfully');
            } catch (error) {
                console.error('Error loading script:', error);
                updateStatus('error', 'Failed to load script data');
            }
        }

        // Load chapter data from the chapters table
        async function loadChapterData(scriptId) {
            console.log('Loading chapters for script ID:', scriptId);
            
            const response = await fetch(`${SUPABASE_URL}/rest/v1/chapters?script_id=eq.${scriptId}&select=*&order=chapter_number.asc`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });

            console.log('Chapters response status:', response.status);

            if (!response.ok) {
                console.warn('No chapters data found');
                return [];
            }

            const data = await response.json();
            console.log('Chapters data received:', data);
            return data || [];
        }

        function displayScriptData(data) {
            if (!data) return;
            document.getElementById('content').style.display = 'block';
            document.getElementById('scriptInfo').style.display = 'grid';
            
            document.getElementById('scriptIdValue').textContent = data.script.script_id || '-';
            document.getElementById('wordsValue').textContent = data.script.target_word_count || '-';
            document.getElementById('clientValue').textContent = data.script.client_name || '-';
            document.getElementById('channelValue').textContent = data.script.channel_name || '-';
            document.getElementById('typeValue').textContent = data.script.script_type || '-';
            document.getElementById('genreValue').textContent = data.script.genre || '-';
            document.getElementById('subgenreValue').textContent = data.script.subgenre || '-';
            document.getElementById('formatValue').textContent = data.script.format || '-';
            document.getElementById('structureValue').textContent = data.script.structure || '-';
            document.getElementById('researchValue').textContent = data.script.research_depth || '-';
            document.getElementById('toneValue').textContent = data.script.tone || '-';
            document.getElementById('angleValue').textContent = data.script.angle || '-';

            // Display chapters
            displayChapters(data.chapters);
        }

        // Display chapters from the chapters table
        function displayChapters(chapters) {
            console.log('displayChapters called with:', chapters);
            const container = document.getElementById('chaptersList');
            container.innerHTML = '';

            if (!chapters || chapters.length === 0) {
                console.log('No chapters to display, chapters array:', chapters);
                container.innerHTML = `
                    <div class="message info">
                        <strong>No chapters found</strong><br>
                        No chapters are available for this script in the database.
                    </div>
                `;
                return;
            }

            console.log('Displaying', chapters.length, 'chapters');

            chapters.forEach(chapter => {
                const chapterSection = document.createElement('div');
                chapterSection.className = 'chapter-se-7a2807fb2c0d';
                
                chapterSection.innerHTML = `
                    <!-- Chapter Header Button -->
                    <button class="gradient-button">
                        <span class="gradient-button__text">Chapter ${chapter.chapter_number || 'N/A'}</span>
                    </button>
                    
                    <!-- Chapter Headline Row -->
                    <div class="ch-title-7a2807fb2c0f">
                        <!-- Chapter Headline Text + Label -->
                        <div class="form-row__text-field">
                            <label class="label-ch-7a2807fb2c1f">Chapter Headline:</label>
                            <div class="title-fiel-7a2807fb2c1e">
                                <input type="text" class="chapter-ti-7a2807fb2c20" 
                                       id="chapter_headline_${chapter.id}" 
                                       data-chapter-id="${chapter.id}"
                                       data-field="chapter_headline"
                                       placeholder="Enter chapter headline..."
                                       value="${chapter.chapter_headline || ''}">
                            </div>
                        </div>
                        
                        <!-- Chapter Headline Rating + Label -->
                        <div class="form-row__rating-field">
                            <div class="rating-field">
                                <label class="rating-field__label">Rating / 100:</label>
                                <div class="rating-field__container">
                                    <input type="number" 
                                           class="rating-field__input" 
                                           id="chapter_headline_rating_${chapter.id}"
                                           data-chapter-id="${chapter.id}"
                                           data-field="chapter_headline_mp_rating" 
                                           min="1" max="100" 
                                           value="${chapter.chapter_headline_mp_rating || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chapter Text Content Row -->
                    <div class="form-row">
                        <div class="form-row__text-field">
                            <div class="text-field-multi">
                                <div class="text-field-multi__container">
                                    <textarea class="text-field-multi__input" 
                                             id="chapter_text_${chapter.id}" 
                                             data-chapter-id="${chapter.id}"
                                             data-field="chapter_text"
                                             style="min-height: 500px; height: 500px;"
                                             placeholder="Enter chapter content...">${chapter.chapter_text || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-row__rating-field">
                            <div class="rating-field">
                                <label class="rating-field__label">Rating / 100:</label>
                                <div class="rating-field__container">
                                    <input type="number" 
                                           class="rating-field__input" 
                                           id="chapter_text_rating_${chapter.id}"
                                           data-chapter-id="${chapter.id}"
                                           data-field="chapter_text_mp_rating"
                                           min="1" 
                                           max="100" 
                                           value="${chapter.chapter_text_mp_rating || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(chapterSection);
            });
        }

        async function saveScript() {
            if (isLoading) return;
            
            try {
                isLoading = true;
                updateStatus('loading', 'Saving chapters and updating status...');
                
                const scriptId = scriptsToReview[currentScriptIndex].script_id;
                
                // Save chapter data
                await saveChaptersData(scriptId);
                
                // Update script status from 25 to 35
                await fetch(`${SUPABASE_URL}/rest/v1/scripts?script_id=eq.${scriptId}`, {
                    method: 'PATCH',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_status_id: 35 })
                });
                
                updateStatus('saved', 'Chapters completed and status updated to 35');
                hasUnsavedChanges = false;
                if (window.setUnsavedChanges) {
                    window.setUnsavedChanges(false);
                }
                
                scriptsToReview.splice(currentScriptIndex, 1);
                
                if (scriptsToReview.length > 0) {
                    if (currentScriptIndex >= scriptsToReview.length) currentScriptIndex = 0;
                    await loadCurrentScriptData();
                } else {
                    showNoScriptsMessage('All chapters completed!');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                updateStatus('error', 'Failed to save chapters');
            } finally {
                isLoading = false;
            }
        }

        // Save chapters data
        async function saveChaptersData(scriptId) {
            const chapterFields = document.querySelectorAll('[data-chapter-id]');
            const updatesByChapter = {};
            
            // Collect all updates by chapter ID
            chapterFields.forEach(field => {
                const chapterId = field.dataset.chapterId;
                const fieldType = field.dataset.field;
                
                if (!updatesByChapter[chapterId]) {
                    updatesByChapter[chapterId] = { id: parseInt(chapterId) };
                }
                
                if (fieldType === 'chapter_headline') {
                    updatesByChapter[chapterId].chapter_headline = field.value;
                } else if (fieldType === 'chapter_headline_mp_rating') {
                    updatesByChapter[chapterId].chapter_headline_mp_rating = parseInt(field.value) || null;
                } else if (fieldType === 'chapter_text') {
                    updatesByChapter[chapterId].chapter_text = field.value;
                } else if (fieldType === 'chapter_text_mp_rating') {
                    updatesByChapter[chapterId].chapter_text_mp_rating = parseInt(field.value) || null;
                }
            });
            
            // Save each chapter individually
            for (const chapterId in updatesByChapter) {
                const update = updatesByChapter[chapterId];
                const { id, ...updateData } = update;
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/chapters?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error(`Failed to save chapter ${id}`);
                }
            }
        }

        async function navigateScript(direction) {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Continue?')) return;
            
            const newIndex = currentScriptIndex + direction;
            if (newIndex >= 0 && newIndex < scriptsToReview.length) {
                currentScriptIndex = newIndex;
                await loadCurrentScriptData();
            }
        }

        function updateNavigationButtons() {
            if (window.updateBottomNavigation) {
                window.updateBottomNavigation(currentScriptIndex, scriptsToReview.length);
            }
        }

        function updateStatus(status, message) {
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                statusIndicator.textContent = message;
                statusIndicator.className = `status-indicator ${status}`;
            }
        }

        function showNoScriptsMessage(message) {
            document.getElementById('content').style.display = 'none';
            document.getElementById('noScriptsMessage').innerHTML = `<div class="message info"><strong>No scripts found</strong><br>${message}</div>`;
            document.getElementById('noScriptsMessage').style.display = 'block';
        }

        // Set up event listeners
        function setupEventListeners() {
            // Add change listeners to mark unsaved changes
            document.addEventListener('input', (e) => {
                if (e.target.dataset.field && e.target.dataset.chapterId) {
                    hasUnsavedChanges = true;
                    if (window.setUnsavedChanges) {
                        window.setUnsavedChanges(true);
                    }
                    updateStatus('editing', 'Editing chapter data...');
                }
            });
        }

        // Auto-save functionality
        function startAutoSave() {
            if (window.bottomNav) {
                window.bottomNav.startAutoSave(async () => {
                    if (hasUnsavedChanges && scriptsToReview.length > 0) {
                        try {
                            const scriptId = scriptsToReview[currentScriptIndex].script_id;
                            await saveChaptersData(scriptId);
                            hasUnsavedChanges = false;
                            updateStatus('saved', 'Auto-saved');
                        } catch (error) {
                            console.error('Auto-save failed:', error);
                            updateStatus('error', 'Auto-save failed');
                        }
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting Chapter Editor...');
            init();
        });

        window.saveScript = saveScript;
        window.navigateScript = navigateScript;
    </script>
    
    <script type="module">
        import BottomNavigation from '../../shared/js/bottom-navigation.js';
        window.bottomNav = new BottomNavigation({
            onSave: () => window.saveScript(),
            onNavigate: (direction) => window.navigateScript(direction),
            showAutoSave: true
        });
        
        window.updateBottomNavigation = (currentIndex, totalItems) => {
            if (window.bottomNav) window.bottomNav.updateNavigation(currentIndex, totalItems);
        };
        
        window.setUnsavedChanges = (hasChanges) => {
            if (window.bottomNav) {
                window.bottomNav.setUnsavedChanges(hasChanges);
            }
        };
    </script>
</body>
</html>